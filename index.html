<!DOCTYPE html>
<html lang="sl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DigiPiflarček</title>

<style>
:root{
  --bg1:#0f2027; --bg2:#203a43; --bg3:#2c5364;
  --card:#ffffff;
  --glass: rgba(255,255,255,.14);
  --glass-brd: rgba(255,255,255,.3);
  --accent:#24c1ff; --accent-dark:#16a2d6;
  --ok:#24c97b; --warn:#f5a524; --err:#ff5a5f;
  --shadow: 0 10px 28px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:#f3f7fb;
  background: radial-gradient(1200px 800px at 10% -10%, #2f6aa8 0%, transparent 60%),
              radial-gradient(1200px 800px at 110% 110%, #2f6aa8 0%, transparent 60%),
              linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));
  background-attachment: fixed;
  font: 15px/1.55 "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}
a{color:#fff}
header{
  position:sticky; top:0; z-index:50;
  display:flex; gap:16px; align-items:center; justify-content:center;
  padding:16px 14px; font-size:26px; font-weight:800; letter-spacing:.3px;
  background: rgba(0,0,0,.25); backdrop-filter: blur(10px);
  border-bottom:1px solid rgba(255,255,255,.08);
  box-shadow: var(--shadow);
}
.subbar{
  position:sticky; top:64px; z-index:40;
  display:flex; gap:8px; justify-content:center; flex-wrap:wrap;
  padding:10px; background: rgba(0,0,0,.2); backdrop-filter: blur(8px);
  border-bottom:1px solid rgba(255,255,255,.07);
}
.btn{
  background: var(--accent); color:#012; border:none; outline:none;
  padding:10px 16px; border-radius:12px; cursor:pointer; font-weight:700;
  box-shadow: 0 6px 18px rgba(0,0,0,.25); transition:.18s;
}
.btn:hover{background:var(--accent-dark); transform: translateY(-1px);}
.btn.ghost{ background:transparent; color:#e9f6ff; border:1px solid rgba(255,255,255,.35) }
.btn.bad{ background:var(--err); color:#fff }
.btn.ok { background:var(--ok); color:#001 }
.btn.warn{ background:var(--warn); color:#000 }
.input, .ta, .sel{
  width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.35);
  background: rgba(255,255,255,.12); color:#e9f6ff;
}
.input::placeholder, .ta::placeholder{color:#dbe8ff}
.glass{
  background: var(--glass); border:1px solid var(--glass-brd); border-radius:16px; box-shadow: var(--shadow);
}
.card{
  background:#fff; color:#0d1b2a; border-radius:16px; box-shadow: var(--shadow);
  border:1px solid rgba(0,0,0,.08);
}
.wrap{ max-width:1200px; margin:18px auto; padding:0 14px; }

/* Vstop / auth */
#authBox{ max-width:480px; margin:80px auto; padding:22px; }

/* Izdaje seznam */
.issue{
  display:flex; align-items:center; gap:12px; padding:12px; margin:8px 0;
  background:#fff; color:#102a43; border-radius:12px; box-shadow: var(--shadow);
  border:1px solid rgba(0,0,0,.06); cursor:pointer;
}
.issue .badge{ margin-left:auto }

/* List člankov */
.article{ overflow:hidden; border-radius:16px; margin:12px 0; }
.article .head{ background: #e6f1ff; border-bottom:1px solid #d6e8ff; padding:10px 12px; }
.article .title{ font-size:18px; font-weight:800; color:#102a43 }
.article .desc{ color:#2f4f7a }
.article .body{ display:flex; gap:0; background:#fff; color:#0b1f2a }
.article .img{ flex:0 0 220px; display:flex; align-items:center; justify-content:center; padding:10px; border-right:1px solid rgba(0,0,0,.06); background:#f6f9ff }
.article img{ max-width:210px; max-height:160px; border-radius:12px; object-fit:cover }
.article .ops{ display:flex; gap:8px; align-items:center; padding:10px; }
.hoverPrev{ transform:translateY(150px); transition:transform .2s ease; padding:10px 12px; border-top:1px solid rgba(0,0,0,.06); background:#fff; color:#111 }
.article:hover .hoverPrev{ transform:translateY(0) }

/* Paper view */
.viewer-wrap{ display:flex; justify-content:center; }
.viewer-a4{
  width:210mm; min-height:297mm; background:#fff; color:#111;
  border:1px solid rgba(0,0,0,.1); border-radius:8px; padding:20mm; line-height:1.7;
  box-shadow:0 16px 32px rgba(0,0,0,.25);
  background-image: radial-gradient(rgba(0,0,0,.03) 1px, transparent 1px); background-size:6px 6px;
}
/* V ogledu uporabljamo .page znotraj .viewer-a4 → .viewer-a4 naj NE ima “papir” stila */
.viewer-a4{
  padding: 0 !important;
  border: none !important;
  box-shadow: none !important;
  background: transparent !important;
}

/* Za vsak slučaj: če je .page znotraj .viewer-a4, naj .page nosi “papir” stil */
.viewer-a4 .page{
  width:210mm; min-height:297mm;
  background:#fff; color:#111;
  border:1px solid rgba(0,0,0,.1);
  border-radius:8px;
  padding:20mm; line-height:1.7;
  box-shadow:0 16px 32px rgba(0,0,0,.25);
  background-image: radial-gradient(rgba(0,0,0,.03) 1px, transparent 1px);
  background-size:6px 6px;
  position:relative;            /* za .movable absolute otroke */
}

/* A4 Editor */
.editor-stage{ display:flex; gap:14px; align-items:flex-start; justify-content:center; min-height:70vh; }
.tool-left, .tool-right{
  position:fixed; top:96px; width:64px; display:flex; flex-direction:column; gap:8px; padding:8px;
  background:rgba(255,255,255,.12); backdrop-filter: blur(10px); border:1px solid rgba(255,255,255,.25);
  border-radius:16px; z-index:30;
}
.tool-left{ left:14px }
.tool-right{ right:14px }
.tool-left .btn, .tool-right .btn{ padding:8px 6px; border-radius:10px; font-weight:700 }
.a4-wrap{ flex:1; display:flex; justify-content:center; }
.a4{
  width:210mm; min-height:297mm; background:#fff; color:#111;
  border:1px solid rgba(0,0,0,.1); border-radius:8px; padding:20mm; line-height:1.7;
  box-shadow:0 16px 32px rgba(0,0,0,.25);
  background-image: radial-gradient(rgba(0,0,0,.03) 1px, transparent 1px); background-size:6px 6px;
  transform-origin: top center;
}
.meta-box{
  background:#e9f2ff; border:1px solid #d5e5ff; border-radius:12px; padding:10px 12px; margin-bottom:8px;
}
.meta-box .meta-title{ width:100%; padding:10px; border-radius:8px; border:1px solid #cfe1ff; background:#fff; font-size:20px; font-weight:800; color:#163a66 }
.meta-box .meta-desc{ width:100%; height:64px; margin-top:6px; padding:10px; border-radius:8px; border:1px solid #cfe1ff; background:#fff; color:#163a66 }

/* === A4 več listov + plavajoče slike === */
.pages{ display:flex; flex-direction:column; align-items:center; gap:18px; }
.page{
  width:210mm; min-height:297mm; background:#fff; color:#111;
  border:1px solid rgba(0,0,0,.1); border-radius:8px; padding:20mm; line-height:1.7;
  box-shadow:0 16px 32px rgba(0,0,0,.25);
  background-image: radial-gradient(rgba(0,0,0,.03) 1px, transparent 1px); background-size:6px 6px;
  transform-origin: top center; position:relative; overflow:hidden;
}
.page[contenteditable="true"]{ outline:none; }
/* prepreči prelitje vsebine iz strani */
.page *{ max-width:100%; box-sizing:border-box; word-wrap:break-word; overflow-wrap:anywhere; }
.page img{ max-width:100%; height:auto; }
.page table{ width:100% !important; table-layout:fixed; border-collapse:collapse; }
.page td,.page th{ word-break:break-word; }

/* udobnejši razmik med stranmi in varnostni spodnji rob */
.pages{ gap:24px; padding-bottom:40px; }

/* bolj jasno upravljanje s plavajočimi elementi */
.movable{ cursor:move; z-index:1; }
.movable.selected{ z-index:999; }
/* plavajoče slike */
.movable{ position:absolute; user-select:none; touch-action:none; }
.movable img{ display:block; max-width:none; max-height:none; }
.movable .handle{
  position:absolute; width:12px; height:12px; border:2px solid #fff;
  background:#24c1ff; border-radius:2px; display:none;
}
.movable.selected .handle{ display:block; }
.movable .h-nw{ left:-6px; top:-6px; cursor:nwse-resize; }
.movable .h-ne{ right:-6px; top:-6px; cursor:nesw-resize; }
.movable .h-se{ right:-6px; bottom:-6px; cursor:nwse-resize; }
.movable .h-sw{ left:-6px; bottom:-6px; cursor:nesw-resize; }

/* pager v ogledu */
.viewerPager{ display:flex; justify-content:center; gap:8px; margin-top:8px }
.viewerBtn{ background:#e6f1ff; color:#102a43; border:1px solid #cfe1ff; padding:6px 10px; border-radius:10px; cursor:pointer; }
.viewerBtn:disabled{ opacity:.5; cursor:default }
/* Chat */
#chatBox{ height:420px; overflow:auto }
.chatRow{ background:rgba(36,193,255,.12); color:#073b59; padding:8px 10px; margin:6px 0; border-radius:12px }
.viewer-a4{
  width:210mm; min-height:297mm; background:#fff; color:#111;
  border:1px solid rgba(0,0,0,.1); border-radius:8px; padding:20mm; line-height:1.7;
  box-shadow:0 16px 32px rgba(0,0,0,.25);
  background-image: radial-gradient(rgba(0,0,0,.03) 1px, transparent 1px); background-size:6px 6px;
  /* DODAJ ↓ */
  position: relative;
}
.movable img {
  pointer-events: none;
}
.movable.selected img {
  pointer-events: auto;
}
/* === [DODAJ] konsistentni margini teksta v .page in .viewer-a4 === */
.page p, .viewer-a4 p { margin: 0 0 10px 0; }
.page h1,.viewer-a4 h1{ margin:14px 0 8px 0 }
.page h2,.viewer-a4 h2{ margin:12px 0 6px 0 }
.page h3,.viewer-a4 h3{ margin:10px 0 6px 0 }

/* === [DODAJ] modal za @glas === */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:10000}
.modal.open{display:flex}
.modal .box{background:#fff;color:#0d1b2a;border-radius:12px;padding:16px;width:min(560px,94vw);box-shadow:0 14px 38px rgba(0,0,0,.35)}
.modal .row{margin:8px 0}
.modal .row label{display:block;font-weight:800;margin-bottom:6px}
.modal .row input,.modal .row textarea,.modal .row select{
  width:100%;padding:10px;border-radius:10px;border:1px solid #cfe1ff;background:#f8fbff;color:#0d1b2a
}
.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.modal .pill{display:inline-flex;align-items:center;gap:8px;background:#eef6ff;border:1px solid #cfe1ff;padding:8px 10px;border-radius:10px;margin:4px 4px 0 0}
.modal .pill b{color:#163a66}

/* Sticky radio (top-right) */
#radioSticky{
  position:fixed; top:18px; right:18px; width:56px; height:56px; border-radius:50%;
  background:rgba(255,255,255,.22); border:1px solid rgba(255,255,255,.45); backdrop-filter: blur(10px);
  display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:9999;
  box-shadow:0 8px 24px rgba(0,0,0,.35); transition:.18s;
  font-size:20px;
}
#radioSticky:hover{ transform:scale(1.06); background:rgba(255,255,255,.3) }
#radioTooltip{
  position:fixed; right:86px; top:26px; padding:6px 10px; border-radius:10px; background:rgba(255,255,255,.98);
  color:#111; border:1px solid rgba(0,0,0,.08); box-shadow:0 10px 24px rgba(0,0,0,.25); display:none; z-index:9999;
}
/* (opcijsko) stil za sistemska sporočila v chatu */
.chatRow.system {
  background: rgba(0,0,0,.08);
  color:#0b1f2a;
  border:1px dashed rgba(0,0,0,.2);
}

/* Print */
@media print{
  header,.subbar,.tool-left,.tool-right,#radioSticky,#radioTooltip{ display:none !important }
  body{ background:#fff }
  .page,.viewer-a4{ box-shadow:none; border:none }
}

</style>
</head>
<body>

<header>📰 DigiPiflarček</header>
<div class="subbar" id="navBar" style="display:none">
  <button class="btn" id="navArticles">Članki</button>
  <button class="btn" id="navChat">Chat</button>
  <button class="btn" id="navRadio">Šolski radio</button>
  <button class="btn" id="navProfile">Profil</button>
  <button class="btn" id="navAdmin" style="display:none">Admin</button>
  <button class="btn ghost" id="navLogout">Odjava</button>
</div>

<!-- AUTH -->
<div id="authBox" class="wrap glass">
  <h2 style="margin-top:0">Dobrodošel! ✨</h2>

  <div style="margin:6px 0 12px 0; padding:10px 12px; border:1px solid rgba(255,255,255,.35); border-radius:10px; background:rgba(255,255,255,.10);">
    <div style="opacity:.95">
      DigiPiflarček je šolski digitalni časopis. Bereš članke, poslušaš šolski radio, klepetaš s sošolci
      in pišeš svoje prispevke na A4 urejevalniku – kot v Wordu. Admin pregleda prispevke in jih objavi.
    </div>
    <ul style="margin:8px 0 0 18px; padding:0; line-height:1.5; opacity:.95">
      <li>📰 Izdaje (mesec/leto) in članki</li>
      <li>✍️ Urejevalnik člankov (A4, WYSIWYG)</li>
      <li>📻 Šolski radio + obvestila</li>
      <li>💬 Klepet (ime in priimek)</li>
    </ul>
  </div>

  <p>Vstopi kot <b>gost</b> ali se prijavi / registriraj.</p>
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <button class="btn" id="btnGuest">Gost</button>
    <button class="btn" id="btnLogin">Prijava</button>
    <button class="btn" id="btnReg">Registracija</button>
  </div>

  <div id="loginBox" style="display:none;margin-top:10px">
    <input class="input" id="lUser" placeholder="Email ali uporabniško ime">
    <input class="input" id="lPass" type="password" placeholder="Geslo">
    <button class="btn" id="doLogin">Prijavi se</button>
  </div>

  <div id="regBox" style="display:none;margin-top:10px">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <input class="input" id="rName" placeholder="Ime">
      <input class="input" id="rSurname" placeholder="Priimek">
    </div>
    <input class="input" id="rEmail" placeholder="Email">
    <input class="input" id="rUser" placeholder="Uporabniško ime">
    <input class="input" id="rPass" type="password" placeholder="Geslo">
    <button class="btn" id="doReg">Ustvari račun</button>
  </div>

  <div id="authMsg" style="margin-top:8px;opacity:.9"></div>
</div>

<!-- STAGE (dinamična vsebina) -->
<div id="stage" class="wrap"></div>
¸
<!-- [DODAJ] Modal za @glas -->
<div id="pollModal" class="modal">
  <div class="box">
    <div class="row">
      <div id="pollTitle" style="font-size:18px;font-weight:900">Glasovanje</div>
      <div id="pollPhase" style="color:#456">Faza …</div>
    </div>
    <div class="row" id="pollProposeWrap" style="display:none">
      <label>Dodaj predlog</label>
      <input id="pollNewProposal" placeholder="Tvoj predlog…">
      <div class="actions" style="justify-content:flex-start">
        <button class="btn" id="pollAddProposal">Dodaj</button>
      </div>
    </div>
    <div class="row">
      <div style="font-weight:800;margin-bottom:6px">Predlogi</div>
      <div id="pollList"></div>
    </div>
    <div class="row" id="pollVoteWrap" style="display:none">
      <label>Izberi</label>
      <select id="pollPick"></select>
    </div>
    <div class="actions">
      <button class="btn ghost" id="pollClose">Zapri</button>
      <button class="btn" id="pollStart"  style="display:none">Začni glasovanje</button>
      <button class="btn ok" id="pollVote" style="display:none">Glasuj</button>
      <button class="btn bad" id="pollEnd"  style="display:none">Zaključi</button>
    </div>
  </div>
</div>


<!-- Sticky radio -->
<div id="radioSticky">▶️</div>
<div id="radioTooltip"></div>
<audio id="radioAudio" preload="auto"></audio>

<!-- ============== JS – celoten app ============== -->
<script type="module">
import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, setDoc, doc, getDoc,
  where, updateDoc, deleteDoc, getDocs, documentId
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref as sRef, uploadBytes, uploadBytesResumable, getDownloadURL }
 from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBQaD0MGnuMa45hm_99VvOwNsTdCoFPgNI",
  authDomain: "school-12a1f.firebaseapp.com",
  projectId: "school-12a1f",
  storageBucket: "school-12a1f.firebasestorage.app",
  messagingSenderId: "539327102547",
  appId: "1:539327102547:web:bd2571f5d327faafaed0a6",
  measurementId: "G-GBG9YCLE12"
};
initializeApp(firebaseConfig);
const app  = getApp();
export const auth = getAuth(app);
export const db   = getFirestore(app);
const st         = getStorage(app);
const stage      = document.getElementById('stage');

/* ---------------- Router ---------------- */
window.navigate = navigate;
window.render   = render;
window.backify  = backify;

function render(view, params){
  if(view==='home')      return window.openEditions?.();
  if(view==='issue')     return window.openIssue?.(params);
  if(view==='article')   return window.openArticleView?.(params);
  if(view==='chat')      return window.openChat?.();
  if(view==='radio')     return window.openRadio?.();
  if(view==='profile')   return window.openProfile?.();
  if(view==='admin')     return window.openAdmin?.();
  if(view==='editor')    return window.openEditor?.(params||null);
}
function navigate(view, params={}, push=true){
  render(view, params);
  if(push) history.pushState({view,params}, '', '#'+view+(params?.id?('-'+params.id):''));
}
window.addEventListener('popstate', e=>{
  const s=e.state||{view:'home',params:{}};
  render(s.view, s.params);
});
function backify(id='backBtn'){
  const b=document.getElementById(id);
  if(b) b.onclick=()=>history.back();
}

/* ---------------- Auth UI ---------------- */
const authBox   = document.getElementById('authBox');
const navBar    = document.getElementById('navBar');
const authMsg   = document.getElementById('authMsg');

document.getElementById('btnGuest').onclick = ()=> enterApp('guest');
document.getElementById('btnLogin').onclick = ()=>{ document.getElementById('loginBox').style.display='block'; document.getElementById('regBox').style.display='none'; }
document.getElementById('btnReg').onclick   = ()=>{ document.getElementById('loginBox').style.display='none'; document.getElementById('regBox').style.display='block'; }

document.getElementById('doReg').onclick = async ()=>{
  const name = rName.value.trim(), sur=rSurname.value.trim(), email=rEmail.value.trim(), user=rUser.value.trim(), pass=rPass.value;
  if(!name||!sur||!email||!user||!pass) return authMsg.textContent='Izpolni vsa polja.';
  try{
    await createUserWithEmailAndPassword(auth, email, pass);
    await setDoc(doc(db,'users',auth.currentUser.uid),{name,surname:sur,email,user,role:'user',created:serverTimestamp()});
    try{ await setDoc(doc(db,'usernames',user),{email}); }catch{}
    authMsg.textContent='Račun ustvarjen. Prijavi se.';
  }catch(e){ authMsg.textContent=e.message; }
};
document.getElementById('doLogin').onclick = async ()=>{
  try{
    let email = lUser.value.trim();
    if(!email.includes('@')){
      const u = await window.lookupUserByUsername(email);
      if(!u) throw new Error('Uporabniško ime ne obstaja.');
      email = u.email;
    }
    await signInWithEmailAndPassword(auth, email, lPass.value);
  }catch(e){ authMsg.textContent=e.message; }
};
document.getElementById('navLogout').onclick = ()=>signOut(auth);

async function refreshAdminButton(){
  const btn = document.getElementById('navAdmin');
  btn.style.display='none';
  if(!auth.currentUser) return;
  const u = await getDoc(doc(db,'users',auth.currentUser.uid));
  if(u.exists() && u.data().role==='admin') btn.style.display='inline-block';
}

// ====== Pomočniki za glasovanje (@glas) ======
const pollRef = doc(db, 'polls', 'active');

async function isAdminUser(){
  if(!auth.currentUser) return false;
  try{
    const u = await getDoc(doc(db,'users',auth.currentUser.uid));
    return u.exists() && u.data().role === 'admin';
  }catch{
    return false;
  }
}

function sysChat(text){
  // Sistemsko sporočilo v chat (za faze in rezultate glasovanja)
  return addDoc(collection(db,'chat'), {
    system: true,
    type: 'poll',
    text,
    time: serverTimestamp()
  });
}

function normalize(s){ return (s||'').trim(); }


/* === [DODAJ] Helperji za % ↔ px pri .movable (zero-shift render) === */
function applyPercentPositions(container){
  if(!container) return;
  const page = container.classList.contains('page') ? container : container.querySelector('.page') || container;
  const pw = page.clientWidth || 1;
  page.querySelectorAll('.movable').forEach(el=>{
    const lp = parseFloat(el.getAttribute('data-left-pct')||el.dataset.leftPct||'');
    const tp = parseFloat(el.getAttribute('data-top-pct') ||el.dataset.topPct ||'');
    const wp = parseFloat(el.getAttribute('data-width-pct')||el.dataset.widthPct||'');
    if(Number.isFinite(lp)) el.style.left  = (lp/100*pw) + 'px';
    if(Number.isFinite(tp)) el.style.top   = (tp/100*pw) + 'px';
    if(Number.isFinite(wp)) el.style.width = (wp/100*pw) + 'px';
    el.style.position='absolute';
  });
}
function serializePageHTML(pageEl){
  const clone = pageEl.cloneNode(true);
  const pw = pageEl.clientWidth || 1;
  clone.querySelectorAll('.movable').forEach(el=>{
    const left = parseFloat(el.style.left||'0');
    const top  = parseFloat(el.style.top||'0');
    const width= parseFloat(el.style.width||el.getBoundingClientRect().width||'0');
    el.setAttribute('data-left-pct',  ((left / pw)  * 100).toFixed(3));
    el.setAttribute('data-top-pct',   ((top  / pw)  * 100).toFixed(3));
    el.setAttribute('data-width-pct', ((width/ pw)  * 100).toFixed(3));
    el.style.left = ''; el.style.top = ''; el.style.width = '';
  });
  return clone.innerHTML;
}




/* ---------------- Chat ---------------- */
const chatCol = collection(db,'chat');
window.openChat = function(){
  stage.innerHTML = `
    <div class="glass wrap" style="padding:14px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:0">💬 Šolski chat</h2>
        <button class="btn ghost" id="backBtn">Nazaj</button>
      </div>
      <div id="chatBox" class="card" style="padding:14px;margin-top:8px"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input class="input" id="chatText" placeholder="Napiši sporočilo...">
        <button class="btn" id="chatSend">Pošlji</button>
      </div>
    </div>
  `;
  backify();
  const box = document.getElementById('chatBox');
  const q   = query(chatCol, orderBy('time','asc'));
  onSnapshot(q, snap=>{
    box.innerHTML='';
    snap.forEach(d=>{
      const x=d.data();
      const div=document.createElement('div');
      if(x.system){
        div.className='chatRow system';
        div.innerHTML = `<span style="font-weight:800">🛎️ Sistem</span><br>${(x.text||'').replace(/\n/g,'<br>')}`;
      }else{
        div.className='chatRow';
        div.innerHTML = `<span style="font-weight:800">${x.userName||'Gost'}</span><br>${x.text}`;
      }
      box.appendChild(div);
    });
    box.scrollTop=box.scrollHeight;
  });

  const send = async ()=>{
    const txt = (chatText.value||'').trim();
    if(!txt) return;
    // @glas → odpri modal
    if(txt.toLowerCase().startsWith('@glas')){
      openPollModal();
      chatText.value='';
      return;
    }
    let userName='Gost';
    if(auth.currentUser){
      const u = await getDoc(doc(db,'users',auth.currentUser.uid));
      if(u.exists()) userName = `${u.data().name||''} ${u.data().surname||''}`.trim() || 'Uporabnik';
    }
    await addDoc(chatCol,{ userName, text: txt, time: serverTimestamp() });
    chatText.value='';
  };
  document.getElementById('chatSend').onclick = send;
  document.getElementById('chatText').addEventListener('keydown', e=>{
    if(e.key==='Enter'){ e.preventDefault(); send(); }
  });
};

/* ====== Nova implementacija @glas modala ====== */

function ui(el){ return document.getElementById(el); }
function openPollModal(){
  const modal = ui('pollModal');
  modal.classList.add('open');

  const titleEl = ui('pollTitle');
  const phaseEl = ui('pollPhase');
  const listEl  = ui('pollList');
  const pickEl  = ui('pollPick');
  const addWrap = ui('pollProposeWrap');
  const voteWrap= ui('pollVoteWrap');
  const btnAdd  = ui('pollAddProposal');
  const btnStart= ui('pollStart');
  const btnVote = ui('pollVote');
  const btnEnd  = ui('pollEnd');

  // reset UI
  listEl.innerHTML=''; pickEl.innerHTML='';
  addWrap.style.display='none'; voteWrap.style.display='none';
  btnAdd.onclick=null; btnStart.style.display='none';
  btnVote.style.display='none'; btnEnd.style.display='none';

  let unsubscribe=null;
  (async()=>{
    const admin = await isAdminUser();

    function renderPoll(poll){
      const phase = poll?.phase || 'propose';
      const pTitle = poll?.title || 'Glasovanje';
      titleEl.textContent = pTitle;
      phaseEl.textContent = (phase==='propose'?'Faza: predlogi':phase==='vote'?'Faza: glasovanje':'Zaključeno');
      const arr = Array.isArray(poll?.proposals)? poll.proposals : [];

      // seznam predlogov (badge s št. glasov)
      listEl.innerHTML = arr.length
        ? arr.map(p=>`<span class="pill"><b>${p.text}</b><span style="color:#456">${p.count||0} glasov</span></span>`).join(' ')
        : `<i>Ni predlogov.</i>`;

      if(phase==='propose'){
        addWrap.style.display='block';
        voteWrap.style.display='none';
        btnStart.style.display = admin?'inline-flex':'none';
        btnEnd.style.display   = 'none';
        btnVote.style.display  = 'none';
        btnAdd.onclick = async ()=>{
          const text = normalize(ui('pollNewProposal').value);
          if(!text) return;
          // dodaj predlog (brez duplikatov)
          const exists = arr.some(p=> (p.text||'').toLowerCase()===text.toLowerCase());
          if(exists){ alert('Ta predlog že obstaja.'); return; }
          const item = {
            id: crypto.randomUUID?crypto.randomUUID():('p_'+Date.now()+'_'+Math.random().toString(36).slice(2)),
            text, by: auth.currentUser?.uid || ('guest-'+Math.random().toString(36).slice(2)),
            ts: Date.now(), count: 0
          };
          await updateDoc(pollRef, { proposals: [...arr, item] });
          ui('pollNewProposal').value='';
        };
        btnStart.onclick = async ()=>{ await updateDoc(pollRef,{phase:'vote'}); };

      }else if(phase==='vote'){
        addWrap.style.display='none';
        voteWrap.style.display='block';
        btnStart.style.display='none';
        btnVote.style.display='inline-flex';
        btnEnd.style.display  = admin?'inline-flex':'none';

        pickEl.innerHTML = arr.map((p,i)=>`<option value="${p.id}">${i+1}. ${p.text} (${p.count||0})</option>`).join('');
        btnVote.onclick = async ()=>{
          if(!arr.length) return alert('Ni predlogov.');
          const choiceId = pickEl.value;
          const votesCol = collection(db,'polls','active','votes');
          const uid = auth.currentUser?.uid || ('guest-'+Math.random().toString(36).slice(2));
          const myVoteRef = doc(votesCol, uid);
          const myVoteSnap= await getDoc(myVoteRef);

          const next = arr.map(p=>({...p}));
          if(myVoteSnap.exists()){
            const prevId = myVoteSnap.data().proposalId;
            const pi=next.findIndex(p=>p.id===prevId); if(pi>=0) next[pi].count=Math.max(0,(next[pi].count||0)-1);
          }
          const ni=next.findIndex(p=>p.id===choiceId); if(ni>=0) next[ni].count=(next[ni].count||0)+1;

          await Promise.all([
            updateDoc(pollRef,{proposals:next}),
            setDoc(myVoteRef,{proposalId:choiceId,at:serverTimestamp()})
          ]);
          alert('Glas zabeležen.');
        };
        btnEnd.onclick = async ()=>{
          const sorted = arr.slice().sort((a,b)=>(b.count||0)-(a.count||0));
          const topN   = poll?.topN || 1;
          const winners= sorted.slice(0, topN);
          await updateDoc(pollRef,{phase:'ended', winners});
        };
      }else{ // ended
        addWrap.style.display='none';
        voteWrap.style.display='none';
        btnStart.style.display='none';
        btnVote.style.display='none';
        btnEnd.style.display='none';
      }
    }

    // Če ni aktivnega → admin lahko ustvari
    const snap = await getDoc(pollRef);
    if(!snap.exists()){
      const canCreate = admin;
      titleEl.textContent='Ni aktivnega glasovanja';
      phaseEl.textContent = canCreate?'Ustvari novo glasovanje.':'Pocakaj na admina.';
      listEl.innerHTML = '';
      addWrap.style.display = canCreate?'block':'none';
      ui('pollNewProposal').placeholder='Naslov glasovanja (nato klikni "Začni")';
      btnAdd.onclick = null;
      btnStart.style.display = canCreate?'inline-flex':'none';
      btnStart.onclick = async ()=>{
        const heading = normalize(ui('pollNewProposal').value||'Glasovanje');
        const nStr = prompt('Koliko TOP zmagovalcev?','1');
        const topN = Math.max(1, parseInt(nStr||'1',10));
        await setDoc(pollRef, { title: heading, topN, phase:'propose', proposals:[], created: serverTimestamp(), createdBy: auth.currentUser?.uid||'anon' });
        await addDoc(collection(db,'chat'),{system:true,type:'poll',text:`Začeli smo glasovanje: “${heading}”. Faza: PREDLOGI.\nVtipkaj @glas za vnos predloga ali kasneje za glasovanje.`,time:serverTimestamp()});
      };
      return;
    }

    // živa posodobitev polja
    unsubscribe = onSnapshot(pollRef, s=> renderPoll(s.data()), err=>console.warn(err));
  })();

  ui('pollClose').onclick = ()=>{
    modal.classList.remove('open');
  };
}


/* ---------------- Radio (playback) ---------------- */
const radioBtn = document.getElementById('radioSticky');
const tip      = document.getElementById('radioTooltip');
const audioEl  = document.getElementById('radioAudio');

let localPlay  = false;
let schedule   = { order:[], tracks:[], repeatPerDay:1, baseStartAt:null };
let nowIdx     = 0;
let nextTimer  = null;
let stateUnsub = null;

radioBtn.addEventListener('mouseenter', ()=>{ tip.style.display='block'; tip.textContent='Šolski radio'; });
radioBtn.addEventListener('mouseleave', ()=> tip.style.display='none');
audioEl.addEventListener('ended', ()=> playIndex(nowIdx+1));

radioBtn.onclick = async ()=>{
  if(schedule.order.length===0){
    const ok = await loadSchedule();
    if(!ok){ alert('Radio se pripravlja (ni objavljen spored ali ni skladb).'); return; }
  }
  localPlay = !localPlay;
  if(localPlay){ startPlayback(); } else { stopPlayback(); }
};

async function loadSchedule(){
  try{
    const stDoc = await getDoc(doc(db,'radioState','scheduler'));
    if(!stDoc.exists()) return false;
    const st = stDoc.data();
    const ord = Array.isArray(st.order)? st.order.filter(Boolean) : [];
    if(ord.length===0) return false;

    const tracks = [];
    for(let i=0;i<ord.length;i+=10){
      const chunk = ord.slice(i,i+10);
      const snap  = await getDocs(query(collection(db,'radioTracks'), where(documentId(),'in', chunk)));
      const byId  = {}; snap.forEach(d=> byId[d.id] = d.data());
      chunk.forEach(id=>{
        const t = byId[id]; if(!t) return;
        const dur = Number.isFinite(+t.durationSec) ? Math.max(10, parseInt(t.durationSec,10)) : 180;
        const url = (t.url||'').trim();
        if(!url) return;
        tracks.push({ id, title: t.title||'Skladba', url, durationSec: dur });
      });
    }
    if(tracks.length===0) return false;

    schedule.order        = ord;
    schedule.tracks       = tracks;
    schedule.repeatPerDay = Math.max(1, parseInt(st.repeatPerDay||1,10));
    schedule.baseStartAt  = st.baseStartAt?.toMillis ? st.baseStartAt.toMillis() : Date.now();

    nowIdx = computeIndexFromClock();

    if(stateUnsub) try{ stateUnsub(); }catch{}
    stateUnsub = onSnapshot(doc(db,'radioState','scheduler'), async (snap)=>{
      if(!snap.exists()) return;
      const newOrder = snap.data().order || [];
      if(JSON.stringify(newOrder)!==JSON.stringify(schedule.order) ||
         (snap.data().repeatPerDay||1)!==schedule.repeatPerDay){
        stopPlayback(false);
        schedule.order = [];
        await loadSchedule();
        if(localPlay) startPlayback();
      }
    });

    return true;
  }catch(e){
    console.warn('loadSchedule fail', e);
    return false;
  }
}
function computeIndexFromClock(){
  const tracks = schedule.tracks;
  const elapsedMs = Date.now() - schedule.baseStartAt;
  const totalDurS = tracks.reduce((sum,t)=> sum + (parseInt(t.durationSec||180,10)||180), 0);
  const loopS     = Math.max(1, totalDurS) * Math.max(1, schedule.repeatPerDay);
  const posS      = Math.floor((elapsedMs/1000) % loopS);

  let acc=0, idx=0;
  for(let i=0;i<tracks.length;i++){
    const d = Math.max(10, parseInt(tracks[i].durationSec||180,10));
    if(posS < acc + d){ idx = i; break; }
    acc += d;
    if(i===tracks.length-1) idx = 0;
  }
  return idx;
}
function startPlayback(){
  if(schedule.tracks.length===0){ alert('Radio se pripravlja (prazna lista).'); localPlay=false; return; }
  nowIdx = computeIndexFromClock();
  playIndex(nowIdx);
  radioBtn.textContent = '⏸️';
}
function stopPlayback(resetTip=true){
  clearTimeout(nextTimer);
  if(!audioEl.paused) audioEl.pause();
  radioBtn.textContent = '▶️';
  if(resetTip) tip.textContent = 'Šolski radio';
}
function playIndex(i){
  clearTimeout(nextTimer);
  const n = schedule.tracks.length;
  if(n===0){ stopPlayback(); return; }
  nowIdx = ((i % n) + n) % n;
  const cur = schedule.tracks[nowIdx];
  const nxt = schedule.tracks[(nowIdx+1)%n];

  audioEl.src = cur.url;
  audioEl.play().catch(()=>{});
  tip.textContent = `${cur.title}${nxt?(' → '+nxt.title):''}`;

  const dur = Math.max(10, parseInt(cur.durationSec||180,10));
  nextTimer = setTimeout(()=> playIndex(nowIdx+1), dur*1000);
}

/* ---------------- Home → IZDAJE ---------------- */
document.getElementById('navArticles').onclick = ()=>navigate('home');
document.getElementById('navChat').onclick     = ()=>navigate('chat');
document.getElementById('navRadio').onclick    = ()=>navigate('radio');
document.getElementById('navProfile').onclick  = ()=>navigate('profile');
document.getElementById('navAdmin').onclick    = ()=>navigate('admin');

window.lookupUserByUsername = async (username)=>{
  try{
    const d = await getDoc(doc(db,'usernames',username));
    return d.exists()? d.data() : null;
  }catch{return null}
};

function badge(ok){ return `<span class="badge ${ok?'ok':'wait'}">${ok?'OBJAVLJENO':'ČAKALNICA'}</span>`; }

/* ============================================================
   IZDAJE – seznam (home)
============================================================ */
window.openEditions = function(){
  stage.innerHTML = `
    <div class="glass" style="padding:12px;display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">📰 Izdaje</div>
      <div>${auth.currentUser? `<button class="btn" id="btnAdd">+ Članek</button>`:''}</div>
    </div>
    <div class="wrap" id="editionList"></div>
  `;
  if(auth.currentUser) document.getElementById('btnAdd').onclick = ()=>navigate('editor');

  const box = document.getElementById('editionList');
  onSnapshot(
    query(collection(db,'editions'), where('published','==',true), orderBy('year','desc'), orderBy('month','desc')),
    (snap)=>{
      box.innerHTML = '';
      if(snap.empty){
        const inf=document.createElement('div');
        inf.className='glass'; inf.style.cssText='padding:12px';
        inf.textContent='Ni objavljenih izdaj.';
        box.appendChild(inf);
        return;
      }
      snap.forEach(ed=>{
        const e=ed.data();
        const item=document.createElement('div');
        item.className='issue';
        const title = e.title?.trim() || `Izdaja ${String(e.month).padStart(2,'0')}/${e.year}`;
        const range = (e.activeFrom||'') && (e.activeTo||'') ? ` · ${e.activeFrom}–${e.activeTo}` : '';
        item.innerHTML = `
          <div style="font-weight:800">${title}</div>
          <div style="color:#2f4f7a">${String(e.month).padStart(2,'0')}/${e.year}${range}</div>
          <span class="badge ok">OBJAVLJENO</span>
        `;
        item.onclick = ()=> navigate('issue', { id: ed.id, title, month: e.month, year: e.year });
        box.appendChild(item);
      });
    },
    (err)=> {
      box.innerHTML = `<div class="glass" style="padding:12px">Napaka pri branju izdaj: ${err.message}</div>`;
    }
  );
};

/* ============================================================
   SEZNAM ČLANKOV V IZDAJI
============================================================ */
window.openIssue = async function(iss){
  const edSnap = await getDoc(doc(db,'editions',iss.id));
  const ed = edSnap.exists()? edSnap.data(): {};
  const title = iss?.title || ed.title?.trim() || `Izdaja ${String(iss?.month||ed.month||'').padStart(2,'0')}/${iss?.year||ed.year||''}`;

  stage.innerHTML = `
    <div class="glass" style="padding:12px;display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">📰 ${title}</div>
      <div><button class="btn ghost" id="backBtn">Nazaj na izdaje</button></div>
    </div>
    <div id="issueWrap"></div>
  `;
  backify();
  const wrap = document.getElementById('issueWrap');

  // ČASOPIS (če objavljen)
  if(ed.newspaperPublished && ed.newspaperHtml){
    const paper = document.createElement('div');
    paper.className='card';
    paper.style.cssText='padding:16px;margin-top:10px';
    paper.innerHTML=`
      <div class="meta-box">
        <div style="font-size:22px;font-weight:900;color:#102a43">${ed.newspaperTitle||'DigiPiflarček — časopis'}</div>
        <div class="desc" style="color:#2f4f7a">Celoten časopis za to izdajo</div>
      </div>
      <div class="viewer-wrap"><div class="viewer-a4" id="paperView"></div></div>
      <div class="viewerPager">
        <button class="viewerBtn" id="pPrev">‹ Prejšnja</button>
        <span id="pInfo" style="align-self:center;color:#102a43"></span>
        <button class="viewerBtn" id="pNext">Naslednja ›</button>
      </div>
    `;
    wrap.appendChild(paper);
    const parts = String(ed.newspaperHtml).split('<!--PAGE_BREAK-->');
    let pg=0; const view=paper.querySelector('#paperView');
    const prev=paper.querySelector('#pPrev'); const next=paper.querySelector('#pNext'); const info=paper.querySelector('#pInfo');
    function render(){ view.classList.add('page');               // .viewer-a4 naj bo tudi .page
view.innerHTML = parts[pg] || '';
applyPercentPositions(view);              // zdaj je “page” kar #viewA4
 info.textContent=`Stran ${pg+1} / ${parts.length}`; prev.disabled=pg===0; next.disabled=pg===parts.length-1; }
    prev.onclick=()=>{ if(pg>0){pg--;render();} }; next.onclick=()=>{ if(pg<parts.length-1){pg++;render();} }; render();
    window.addEventListener('resize', ()=> applyPercentPositions(view.firstElementChild));
  }

  // Seznam objavljenih člankov pod časopisom
  const list = document.createElement('div'); list.id='list'; wrap.appendChild(list);

  onSnapshot(
    query(collection(db,'articles'), where('approved','==',true), where('editionId','==', iss.id), orderBy('created','desc')),
    (snap)=>{
      list.innerHTML='';
      if(snap.empty){
        const inf=document.createElement('div'); inf.className='glass'; inf.style.cssText='padding:12px;background:#fff;color:#102a43';
        inf.textContent='V tej izdaji še ni člankov.'; list.appendChild(inf); return;
      }
      snap.forEach(d=>{
        const data=d.data();
        const plain=(data.content||'').replace(/<[^>]+>/g,'');
        const preview = data.desc?.trim()? data.desc.trim() : (plain.substring(0,160)+'…');
        const card=document.createElement('div');
        card.className='article card';
        card.innerHTML=`
          <div class="head"><div class="title">${data.title}</div><div class="desc">${preview}</div></div>
          <div class="body">
            ${data.img? `<div class="img"><img src="${data.img}"></div>`:''}
            <div style="flex:1;padding:10px 12px">
              <div class="ops">
                <button class="btn read">Odpri</button>
                ${auth.currentUser? `<button class="btn ghost save">Shrani</button>`:''}
                <span style="margin-left:auto;color:#5a6c7d;font-size:12px">${data.created?.toDate? data.created.toDate().toLocaleString():''}</span>
              </div>
            </div>
          </div>
          <div class="hoverPrev">${plain.substring(0,420)}${plain.length>420?'…':''}</div>
        `;
        card.querySelector('.read').onclick = ()=>navigate('article',{id:d.id,...data});
        const sbtn = card.querySelector('.save');
        if(sbtn){
          sbtn.onclick = ()=> setDoc(doc(db,'users',auth.currentUser.uid,'favorites',d.id),{
            articleId:d.id,title:data.title,img:data.img||'',savedAt:serverTimestamp()
          });
        }
        list.appendChild(card);
      });
    },
    (err)=> list.innerHTML = `<div class="glass" style="padding:12px;background:#fff;color:#102a43">Napaka: ${err.message}</div>`
  );
};


/* ============================================================
   OGLED članka – A4 VIEWER (paging)
============================================================ */
window.openArticleView = function(d){
  stage.innerHTML = `
    <div class="glass" style="padding:12px;display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">📰 Članek</div>
      <button class="btn ghost" id="backBtn">Nazaj</button>
    </div>
    <div class="card" style="padding:16px;margin-top:10px">
      <div class="meta-box">
        <div style="font-size:22px;font-weight:900;color:#102a43">${d.title}</div>
        <div class="desc" style="color:#2f4f7a">${d.desc||''}</div>
      </div>
      ${d.img? `<img src="${d.img}" style="max-width:100%;border-radius:12px;margin:8px 0">`:''}
      <div class="viewer-wrap">
        <div class="viewer-a4" id="viewA4"></div>
      </div>
      <div class="viewerPager">
        <button class="viewerBtn" id="prevPg">‹ Prejšnja</button>
        <span id="pgInfo" style="align-self:center;color:#102a43"></span>
        <button class="viewerBtn" id="nextPg">Naslednja ›</button>
      </div>
    </div>
  `;
  backify();
  const parts = String(d.content||'').split('<!--PAGE_BREAK-->');
  let pg = 0;
  const view = document.getElementById('viewA4');
  const prev = document.getElementById('prevPg');
  const next = document.getElementById('nextPg');
  const info = document.getElementById('pgInfo');
  function renderPg(){
  view.classList.add('page');               // .viewer-a4 naj bo tudi .page
view.innerHTML = parts[pg] || '';
applyPercentPositions(view);              // zdaj je “page” kar #viewA4

  info.textContent = `Stran ${pg+1} / ${parts.length}`;
  prev.disabled = pg===0;
  next.disabled = pg===parts.length-1;
}

  prev.onclick = ()=>{ if(pg>0){ pg--; renderPg(); } };
  next.onclick = ()=>{ if(pg<parts.length-1){ pg++; renderPg(); } };
  document.addEventListener('keydown', (e)=>{
    if(e.key==='ArrowLeft') prev.click();
    if(e.key==='ArrowRight') next.click();
  });
  renderPg();
};

/* ============================================================
   A4 UREJEVALNIK – več listov + plavajoče slike
============================================================ */
window.openEditor = function(existing=null){
  stage.innerHTML = `
    <div class="glass" style="padding:12px;display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">✍️ Urejevalnik (A4)</div>
      <div>
        <button class="btn" id="saveBtn">💾 Shrani</button>
        <button class="btn ghost" id="backBtn">Nazaj</button>
      </div>
    </div>

    <div class="editor-stage">
      <!-- orodja levo -->
      <div class="tool-left">
        <select class="sel" id="fontName">
          <option value="inherit">Font</option>
          <option>Arial</option><option>Times New Roman</option>
          <option>Georgia</option><option>Calibri</option><option>Cambria</option>
        </select>
        <select class="sel" id="fontSize">
          <option value="2">10pt</option><option value="3" selected>12pt</option>
          <option value="4">14pt</option><option value="5">18pt</option><option value="6">24pt</option>
        </select>
        <select class="sel" id="headings">
          <option value="P">Navadno</option>
          <option value="H1">H1</option><option value="H2">H2</option><option value="H3">H3</option>
        </select>
        <input type="color" id="foreColor" title="Barva besedila">
        <input type="color" id="backColor" title="Ozadje besedila">
        <button class="btn" data-cmd="bold"><b>B</b></button>
        <button class="btn" data-cmd="italic"><i>I</i></button>
        <button class="btn" data-cmd="underline"><u>U</u></button>
        <button class="btn" data-cmd="strikeThrough">S</button>
        <button class="btn" data-cmd="insertUnorderedList">•</button>
        <button class="btn" data-cmd="insertOrderedList">1.</button>
        <button class="btn" data-cmd="outdent">↤</button>
        <button class="btn" data-cmd="indent">↦</button>
      </div>

      <!-- listi -->
      <div class="a4-wrap">
        <div style="max-width:210mm;width:100%;">
          <div class="meta-box">
            <input class="meta-title" id="titleInput" placeholder="Naslov članka">
            <textarea class="meta-desc" id="descInput" maxlength="150" placeholder="Kratek opis (za seznam) – do 150 znakov"></textarea>
            <div style="display:flex; gap:8px; margin-top:6px; align-items:center">
              <label style="color:#163a66; font-weight:800">Izdaja:</label>
              <select id="editionSelect" class="sel" style="max-width:340px"></select>
              <small style="color:#456">(izberi številko izdaje)</small>
            </div>
          </div>

          <div id="pages" class="pages"></div>
          <div style="text-align:center;color:#7a8aa0;margin:8px 0"><span id="pageCounter">Stran 1</span></div>

          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <label>Naslovna slika: </label>
            <input id="imgUpload" type="file" accept="image/*" class="input" style="max-width:320px">
            <span id="imgHeroInfo" style="color:#163a66;font-size:12px"></span>
          </div>

          <!-- skriti input za inline sliko + progress -->
          <input id="inlineImgInput" type="file" accept="image/*" style="display:none">
          <div id="imgUpWrap" style="height:6px;background:#eee;border-radius:6px;overflow:hidden;margin-top:6px;display:none">
            <div id="imgUpBar" style="height:100%;width:0%;background:#24c1ff;transition:width .15s linear"></div>
          </div>
          <div id="imgUpTxt" style="font-size:12px;color:#234;margin-top:4px;display:none">Pripravljeno…</div>
        </div>
      </div>

      <!-- orodja desno -->
      <div class="tool-right">
        <button class="btn" id="sup">x²</button>
        <button class="btn" id="sub">x₂</button>
        <button class="btn" id="addPageBtn">➕ Stran</button>
        <button class="btn" id="linkBtn">🔗</button>
        <button class="btn" id="imgBtn">🖼️</button>
        <button class="btn" id="tableBtn">▦</button>
        <button class="btn" id="clearFmt">⌫</button>
        <button class="btn" id="undoBtn">↶</button>
        <button class="btn" id="redoBtn">↷</button>
        <button class="btn" id="exportPdf">🖨️</button>
        <button class="btn" id="exportHtml">⬇️</button>
        <div class="glass" style="padding:6px 8px;text-align:center">
          <div>Zoom</div>
          <button class="btn" id="zOut">−</button>
          <div id="zVal" style="padding:4px 0;font-weight:800">100%</div>
          <button class="btn" id="zIn">＋</button>
          <div id="wc" style="margin-top:6px;font-size:12px;color:#e4f6ff">0 besed</div>
        </div>
      </div>
    </div>
  `;
  backify();

  /* --- napolni izdaje --- */
  const sel = document.getElementById('editionSelect');
  sel.innerHTML = `<option value="">— izberi izdajo —</option>`;
  onSnapshot(
    query(collection(db,'editions'), where('published','==',true), orderBy('year','desc'), orderBy('month','desc')),
    (snap)=>{
      sel.innerHTML = `<option value="">— izberi izdajo —</option>`;
      snap.forEach(ed=>{
        const e=ed.data();
        const title = e.title?.trim() || `Izdaja ${String(e.month).padStart(2,'0')}/${e.year}`;
        const opt = document.createElement('option');
        opt.value = ed.id; opt.textContent = title;
        sel.appendChild(opt);
      });
      if(existing?.editionId) sel.value = existing.editionId;
    }
  );

  /* --- helperji za strani --- */
  const pagesWrap = document.getElementById('pages');
  const pageCounter = document.getElementById('pageCounter');

  function updateCounter(){ pageCounter.textContent = `Strani: ${pagesWrap.children.length}`; }

  function createPage(html=''){
    const pg = document.createElement('div');
    pg.className='page';
    pg.contentEditable='true';
    pg.innerHTML = html || '<p>Začni pisati svoj članek tukaj…</p>';
    pg.addEventListener('focusin', ()=>{ currentPage = pg; });
pg.addEventListener('pointerdown', ()=>{ currentPage = pg; });
    // omogoči deselect slik ob kliku na ozadje
    pg.addEventListener('mousedown', (e)=>{ if(e.target===pg) deselectMovable(); });
    pagesWrap.appendChild(pg);
    if(!currentPage) currentPage=pg;
    updateCounter();
    return pg;
  }

  // initial pages (obstoječa vsebina)
  let currentPage = null;
  // -- zanesljivo določanje aktivne strani
function setCurrentPageFromEvent(e){
  const n = e?.target || document.activeElement;
  const el = (n && n.closest) ? n.closest('.page') : null;
  if (el) currentPage = el;
}
pagesWrap.addEventListener('pointerdown', setCurrentPageFromEvent);
pagesWrap.addEventListener('focusin', setCurrentPageFromEvent);

// tudi ob spremembi selekcije (kurzor v besedilu)
document.addEventListener('selectionchange', ()=>{
  const sel = document.getSelection();
  if(!sel || !sel.anchorNode) return;
  const node = sel.anchorNode.nodeType===1 ? sel.anchorNode : sel.anchorNode.parentElement;
  const pg = node && node.closest ? node.closest('.page') : null;
  if(pg) currentPage = pg;
});

  const title = document.getElementById('titleInput');
  const desc  = document.getElementById('descInput');

  const initial = existing?.content ? String(existing.content).split('<!--PAGE_BREAK-->') : [''];
  initial.forEach(html=> createPage(html||'<p></p>'));
  [...pagesWrap.children].forEach(pg => applyPercentPositions(pg));


  /* --- execCommand orodja za besedilo --- */
  document.querySelectorAll('[data-cmd]').forEach(b=> b.onclick=()=>document.execCommand(b.dataset.cmd,false,null));
  const headings=document.getElementById('headings');
  const fontName=document.getElementById('fontName');
  const fontSize=document.getElementById('fontSize');
  const foreColor=document.getElementById('foreColor');
  const backColor=document.getElementById('backColor');
  const sup=document.getElementById('sup');
  const sub=document.getElementById('sub');
  const linkBtn=document.getElementById('linkBtn');
  const tableBtn=document.getElementById('tableBtn');
  const clearFmt=document.getElementById('clearFmt');
  const undoBtn=document.getElementById('undoBtn');
  const redoBtn=document.getElementById('redoBtn');
  const exportPdf=document.getElementById('exportPdf');
  const exportHtml=document.getElementById('exportHtml');
  const zIn=document.getElementById('zIn');
  const zOut=document.getElementById('zOut');
  const zVal=document.getElementById('zVal');

  foreColor.onchange=e=>document.execCommand('foreColor',false,e.target.value);
  backColor.onchange=e=>document.execCommand('hiliteColor',false,e.target.value);
  fontName.onchange=e=>document.execCommand('fontName',false,e.target.value);
  fontSize.onchange=e=>document.execCommand('fontSize',false,e.target.value);
  headings.onchange=e=>document.execCommand('formatBlock',false, e.target.value==='P'?'p':e.target.value);
  sup.onclick = ()=>document.execCommand('superscript',false,null);
  sub.onclick = ()=>document.execCommand('subscript',false,null);
  linkBtn.onclick=()=>{ const u=prompt('URL:'); if(u) document.execCommand('createLink',false,u); };

  tableBtn.onclick=()=>{
    const r=parseInt(prompt('Vrstice 1–10','3')||'3',10);
    const c=parseInt(prompt('Stolpci 1–10','3')||'3',10);
    if(r>0&&c>0&&r<=10&&c<=10){
      let html='<table style="width:100%;border-collapse:collapse;border:1px solid #ccc;">';
      for(let i=0;i<r;i++){ html+='<tr>'; for(let j=0;j<c;j++){ html+='<td style="border:1px solid #ccc;padding:6px;">&nbsp;</td>'; } html+='</tr>'; }
      html+='</table>'; document.execCommand('insertHTML',false,html);
    }
  };
  clearFmt.onclick=()=>{document.execCommand('removeFormat',false,null);document.execCommand('unlink',false,null)};
  undoBtn.onclick =()=>document.execCommand('undo',false,null);
  redoBtn.onclick =()=>document.execCommand('redo',false,null);
  exportPdf.onclick=()=>window.print();
  exportHtml.onclick=()=>{
    const html = pagesHTML().join('<!--PAGE_BREAK-->');
    const blob=new Blob([html],{type:'text/html;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(title.value||'clanek')+'.html'; a.click();
  };

  // dodaj novo stran
  document.getElementById('addPageBtn').onclick = ()=>{
    const pg = createPage('<p>&nbsp;</p>');
    setTimeout(()=>{ pg.focus(); }, 0);
  };

  /* --- zoom na strani --- */
  let zoom=1;
  function fit(){
    const target=793;
    const free = window.innerWidth - 64 - 64 - 60;
    zoom = Math.max(0.6, Math.min(1.2, free/target));
    [...pagesWrap.children].forEach(p=> p.style.transform=`scale(${zoom})`);
    zVal.innerText=Math.round(zoom*100)+'%';
  }
  window.addEventListener('resize',fit); fit();
  zIn.onclick =()=>{ zoom=Math.min(2,zoom+0.1); [...pagesWrap.children].forEach(p=> p.style.transform=`scale(${zoom})`); zVal.innerText=Math.round(zoom*100)+'%'; };
  zOut.onclick=()=>{ zoom=Math.max(0.5,zoom-0.1); [...pagesWrap.children].forEach(p=> p.style.transform=`scale(${zoom})`); zVal.innerText=Math.round(zoom*100)+'%'; };

  /* --- števec besed + draft --- */
  function textAllPages(){
    return [...pagesWrap.children].map(p=> (p.innerText||'')).join(' ');
  }
  function wc(){
    const n=(textAllPages()||'').trim().replace(/\s+/g,' ').split(' ').filter(Boolean).length;
    document.getElementById('wc').innerText=`${n} besed`;
  }
  pagesWrap.addEventListener('input',()=>{ wc(); saveDraftThrottled(); });
  wc();

  const draftKey= auth.currentUser? ('draft_'+auth.currentUser.uid): 'draft_guest';
  let t=null;
  function pagesHTML(){
  return [...pagesWrap.children].map(p=> serializePageHTML(p));
}
  function saveDraftThrottled(){
    clearTimeout(t);
    t=setTimeout(()=>localStorage.setItem(
      draftKey,
      JSON.stringify({title:title.value,desc:desc.value,content:pagesHTML().join('<!--PAGE_BREAK-->'),editionId:editionSelect.value})
    ), 600);
  }
  if(!existing){
    const raw=localStorage.getItem(draftKey);
    if(raw){
      try{
        const d=JSON.parse(raw);
        title.value=d.title||'';
        desc.value=d.desc||'';
        if(d.content){
          pagesWrap.innerHTML='';
          String(d.content).split('<!--PAGE_BREAK-->').forEach(h=> createPage(h));
        }
        if(d.editionId) editionSelect.value=d.editionId;
      }catch{}
    }
  }else{
    title.value=existing.title||'';
    desc.value=existing.desc||'';
    document.getElementById('saveBtn').dataset.editId=existing.id||'';
  }

  /* --- NASLOVNA slika (Storage) --- */
  let heroURL = existing?.img || '';
  imgUpload.onchange = async e=>{
    const f=e.target.files[0]; if(!f) return;
    const safeName = f.name.replace(/\s+/g,'_');
    const r=sRef(st,'articleImages/'+Date.now()+'_'+safeName);
    try{
      await uploadBytes(r,f);
      heroURL=await getDownloadURL(r);
      document.getElementById('imgHeroInfo').textContent='Slika naložena ✔️';
    }catch(err){
      alert('Napaka pri nalaganju slike: '+(err?.message||err));
      document.getElementById('imgHeroInfo').textContent='Napaka ❌';
    }
  };

  /* --- INLINE SLIKE: naloži → vstavi kot .movable na trenutno stran --- */
  const inlineImgInput = document.getElementById('inlineImgInput');
  const imgBtn = document.getElementById('imgBtn');
  const imgUpWrap = document.getElementById('imgUpWrap');
  const imgUpBar  = document.getElementById('imgUpBar');
  const imgUpTxt  = document.getElementById('imgUpTxt');
let targetPageForImage = null;

  imgBtn.onclick = ()=>{
  targetPageForImage = currentPage;  // zapomni aktivni list
  inlineImgInput.click();
};

inlineImgInput.onchange = async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const safeName = f.name.replace(/\s+/g,'_');
  const r=sRef(st,'articleImages/'+Date.now()+'_'+safeName);
  imgUpWrap.style.display='block'; imgUpTxt.style.display='block'; imgUpBar.style.width='0%'; imgUpTxt.textContent='Nalaganje…';
  try{
    const task = uploadBytesResumable(r, f, {contentType: f.type||'image/jpeg'});
    await new Promise((resolve,reject)=>{
      task.on('state_changed', (snap)=>{
        const pct = Math.round(snap.bytesTransferred/snap.totalBytes*100);
        imgUpBar.style.width = pct+'%';
        imgUpTxt.textContent = `Nalaganje slike: ${pct}%`;
      }, reject, resolve);
    });
    const url = await getDownloadURL(r);
    insertMovableImage(url, targetPageForImage);   // <-- vstavi v izbrani list
    imgUpTxt.textContent='Končano ✔️';
  }catch(err){
    alert('Napaka pri nalaganju slike: '+(err?.message||err));
    imgUpTxt.textContent='Napaka ❌';
  }finally{
    targetPageForImage = null;
    setTimeout(()=>{ imgUpWrap.style.display='none'; imgUpTxt.style.display='none'; imgUpBar.style.width='0%'; }, 700);
    inlineImgInput.value='';
  }
};


  /* --- Premikanje & resize .movable --- */
let selMovable = null;
let dragMode = null; // 'move' | 'nw'|'ne'|'se'|'sw'
let startX=0, startY=0, startLeft=0, startTop=0, startW=0, startH=0;

function deselectMovable(){ if(selMovable){ selMovable.classList.remove('selected'); selMovable=null; } }

function selectMovable(el){
  if(selMovable && selMovable!==el) selMovable.classList.remove('selected');
  selMovable = el; selMovable.classList.add('selected');
  // dvigni izbran element nad ostale
  selMovable.style.zIndex = String(Date.now() % 1e9);
}

function clampToPage(el){
  const pg = el.parentElement;
  const pw = pg.clientWidth;
  const ph = pg.clientHeight;
  let left = parseFloat(el.style.left)||0;
  let top  = parseFloat(el.style.top)||0;
  const w  = el.offsetWidth;
  const h  = el.offsetHeight;
  left = Math.max(0, Math.min(left, pw - w));
  top  = Math.max(0, Math.min(top,  ph - h));
  el.style.left = left + 'px';
  el.style.top  = top  + 'px';
}

function insertMovableImage(url, pageOverride){
  const pg = pageOverride || currentPage || createPage();
  const wrap = document.createElement('div');
  wrap.className='movable';
  const maxInit = Math.min(pg.clientWidth * 0.4, 240);
  wrap.style.left='20px'; wrap.style.top='20px';
  wrap.style.width= Math.max(120, maxInit) + 'px';
  wrap.style.height='auto';
 wrap.addEventListener('pointerdown', (e)=>{
  e.preventDefault();
  selectMovable(wrap);

  // zagotovimo, da prejemamo move/up tudi če gre kurzor iz elementa
  try { wrap.setPointerCapture(e.pointerId); } catch {}

  const rect = wrap.getBoundingClientRect();
  const pageRect = pg.getBoundingClientRect();
  startX = e.clientX; startY = e.clientY;
  startLeft = rect.left - pageRect.left + pg.scrollLeft;
  startTop  = rect.top  - pageRect.top  + pg.scrollTop;
  startW = rect.width; startH = rect.height;

  const h = e.target.closest('.handle');
  dragMode = h ? h.dataset.handle : 'move';

  // poslušamo na dokumentu – pointer dogodki
  const move = (ev)=> onDrag(ev);
  const up   = (ev)=> { onDragEnd(); document.removeEventListener('pointermove', move); document.removeEventListener('pointerup', up); };

  document.addEventListener('pointermove', move);
  document.addEventListener('pointerup',   up, { once:true });
});

  const img = document.createElement('img');
  img.src=url; img.draggable=false; img.style.width='100%'; img.style.height='auto';
  wrap.appendChild(img);

  ['nw','ne','se','sw'].forEach(h=>{
    const s=document.createElement('div');
    s.className='handle h-'+h; s.dataset.handle=h;
    wrap.appendChild(s);
  });

  // ... (ostane isto: mousedown, onDrag, clampToPage ...)
  pg.appendChild(wrap);
  selectMovable(wrap);
  clampToPage(wrap);
  // po želji: scrollaj na stran
  pg.scrollIntoView({behavior:'smooth', block:'center'});
}

function onDrag(e){
  if(!selMovable || !dragMode) return;
  const pg = selMovable.parentElement;
  const pw = pg.clientWidth, ph = pg.clientHeight;
  const dx = (e.clientX - startX), dy = (e.clientY - startY);

  if(dragMode==='move'){
    let left = startLeft + dx;
    let top  = startTop  + dy;
    left = Math.max(0, Math.min(left, pw - selMovable.offsetWidth));
    top  = Math.max(0, Math.min(top,  ph - selMovable.offsetHeight));
    selMovable.style.left = left + 'px';
    selMovable.style.top  = top  + 'px';
  }else{
    let newW = startW, newH = startH, newLeft = startLeft, newTop = startTop;

    if(dragMode.includes('e')) newW = Math.max(40, startW + dx);
    if(dragMode.includes('s')) newH = Math.max(40, startH + dy);
    if(dragMode.includes('w')){ newW = Math.max(40, startW - dx); newLeft = startLeft + dx; }
    if(dragMode.includes('n')){ newH = Math.max(40, startH - dy); newTop  = startTop  + dy; }

    if(newLeft < 0){ newW += newLeft; newLeft = 0; }
    if(newTop  < 0){ newH += newTop;  newTop  = 0; }
    newW = Math.min(newW, pw - newLeft);
    newH = Math.min(newH, ph - newTop);

    selMovable.style.width = newW + 'px';
    selMovable.style.height= newH + 'px';
    selMovable.style.left  = newLeft + 'px';
    selMovable.style.top   = newTop  + 'px';
  }
}

function onDragEnd(){
  dragMode=null;
  if(selMovable) clampToPage(selMovable);
}

pagesWrap.addEventListener('paste', (e)=>{
  // prilepi samo čisti tekst (odstrani ogromne inline stile)
  if(e.clipboardData){
    e.preventDefault();
    const text = e.clipboardData.getData('text/plain');
    document.execCommand('insertText', false, text);
  }
});


  // deselect ob ESC
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') deselectMovable(); });

  /* --- Shrani --- */
  document.getElementById('saveBtn').onclick = async ()=>{
    const base={ title:title.value.trim(), desc:desc.value.trim(),
      content: pagesHTML().join('<!--PAGE_BREAK-->'),
      img: heroURL,
      author:auth.currentUser? auth.currentUser.email : 'Gost',
      edited:serverTimestamp(),
      editionId: editionSelect.value || null
    };
    if(!base.title || !base.desc) return alert('Naslov in kratek opis sta obvezna.');
    if(!base.editionId) if(!confirm('Članek ni dodeljen nobeni izdaji. Nadaljujem?')) return;
    const id = document.getElementById('saveBtn').dataset.editId;
    try{
      if(id){ await updateDoc(doc(db,'articles',id), base); alert('Posodobljeno.'); }
      else { await addDoc(collection(db,'articles'), {...base, created:serverTimestamp(), approved:false}); alert('Poslano uredniku.'); }
      localStorage.removeItem(draftKey); navigate('home');
    }catch(e){ alert('Napaka pri shranjevanju: '+e.message); }
  };
};
// === [FIX] Odpri editor za ČASOPIS z gumbom “Objavi časopis”
window.openEditorForNewspaper = function(editionId, existing) {
  // recikliramo UI urejevalnika
  window.openEditor(existing);
  // Ne shranjuj kot “članek” – to je časopis.
const saveBtn = document.getElementById('saveBtn');
if (saveBtn) saveBtn.dataset.editId = '';  // izklopi update na 'articles'


  // naslov/desc – izpolni iz obstoječega časopisa
  const titleInput = document.getElementById('titleInput');
  const descInput  = document.getElementById('descInput');
  if (existing?.title) titleInput.value = existing.title;
  if (existing?.desc)  descInput.value  = existing.desc;

  // skrij/zakleni izbor izdaje (časopis je vezan na konkretno izdajo)
  const editionSelect = document.getElementById('editionSelect');
  if (editionSelect) {
    editionSelect.value = editionId;
    editionSelect.disabled = true;
    editionSelect.title = 'Časopis je vezan na to izdajo';
  }

  // dodaj “Objavi časopis” zraven Shrani
  let publishBtn = document.getElementById('publishNewspaperBtn');
  if (!publishBtn) {
    publishBtn = document.createElement('button');
    publishBtn.className = 'btn ok';
    publishBtn.id = 'publishNewspaperBtn';
    publishBtn.textContent = '📰 Objavi časopis';
    saveBtn.insertAdjacentElement('beforebegin', publishBtn);
  }

  publishBtn.onclick = async () => {
    try {
      const pagesWrap = document.getElementById('pages');
      const joinedHTML = [...pagesWrap.children]
        .map(p => serializePageHTML(p))   // % pozicije za .movable
        .join('<!--PAGE_BREAK-->');

      const edRef = doc(db, 'editions', editionId);
      const edSnap = await getDoc(edRef);
      const ed = edSnap.data() || {};
      const humanTitle = ed.title?.trim() || `Izdaja ${String(ed.month).padStart(2,'0')}/${ed.year}`;

      await updateDoc(edRef, {
        newspaperHtml: joinedHTML,       // objavljena različica
        newspaperDraft: joinedHTML,      // tudi draft posodobimo
        newspaperTitle: `DigiPiflarček — ${humanTitle}`,
        newspaperPublished: true,
        updated: serverTimestamp()
      });

      alert('Časopis objavljen. V izdaji bo prikazan nad članki.');
      navigate('admin');
    } catch (e) {
      alert('Napaka pri objavi časopisa: ' + (e?.message || e));
    }
  };
};



/* ============================================================
   PROFIL
============================================================ */
window.openProfile = function(){
  stage.innerHTML = `
    <div class="glass" style="padding:12px;display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">👤 Moj profil</div>
      <button class="btn ghost" id="backBtn">Nazaj</button>
    </div>
    <div class="glass" style="padding:14px;margin-top:8px">
      <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start">
        <div class="card" style="flex:1;min-width:260px;padding:12px">
          <h3 style="margin:0 0 6px 0">Uporabnik</h3>
          <img id="avatar" src="https://www.gravatar.com/avatar?d=mp&s=120" style="width:120px;height:120px;object-fit:cover;border-radius:50%">
          <input id="avUp" type="file" accept="image/*" class="input" style="max-width:260px;margin-top:6px">
          <div id="uName" style="margin-top:6px"></div>
          <div id="uMail" style="color:#456"></div>
        </div>
        <div class="card" style="flex:2;min-width:320px;padding:12px">
          <h3 style="margin:0 0 6px 0">Moji članki</h3>
          <div id="myArts"></div>
          <h3>Shanjeni članki</h3>
          <div id="favArts"></div>
        </div>
      </div>
    </div>
  `;
  backify();
  if(!auth.currentUser){ uName.textContent='Gost'; return; }
  (async()=>{
    const u=await getDoc(doc(db,'users',auth.currentUser.uid));
    if(u.exists()){ const d=u.data(); uName.textContent=`${d.name||''} ${d.surname||''}`; uMail.textContent=d.email||auth.currentUser.email; if(d.avatar) avatar.src=d.avatar; }
  })();
  avUp.onchange=async e=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const path = 'avatars/'+(auth.currentUser?.uid||('guest-'+Date.now()))+'.jpg';
    const r=sRef(st, path);
    await uploadBytes(r,f);
    const url=await getDownloadURL(r);
    avatar.src=url; // takoj osveži UI
    await setDoc(doc(db,'users',auth.currentUser.uid),{avatar:url},{merge:true});
  }catch(err){
    alert('Napaka pri nalaganju avatarja: '+(err?.message||err));
  }
};
  onSnapshot(query(collection(db,'articles'), where('author','==',auth.currentUser.email), orderBy('created','desc')), (snap)=>{
    myArts.innerHTML=''; snap.forEach(s=>{
      const d=s.data(); const row=document.createElement('div'); row.className='glass'; row.style.cssText='padding:8px 10px;margin:6px 0;background:#fff;color:#0d1b2a';
      row.innerHTML = `<b>${d.title}</b> ${badge(d.approved)} ${d.editionId?`<span style="color:#567"> · izdaja</span>`:''}`; myArts.appendChild(row);
    });
  });
  onSnapshot(query(collection(db,'users',auth.currentUser.uid,'favorites'), orderBy('savedAt','desc')), (snap)=>{
    favArts.innerHTML=''; snap.forEach(s=>{
      const f=s.data(); const row=document.createElement('div'); row.className='glass'; row.style.cssText='padding:8px 10px;margin:6px 0;background:#fff;color:#0d1b2a;display:flex;justify-content:space-between';
      row.innerHTML = `<span>${f.title}</span><button class="btn bad" data-id="${s.id}">Odstrani</button>`;
      row.querySelector('button').onclick = ()=> deleteDoc(doc(db,'users',auth.currentUser.uid,'favorites',s.id));
      favArts.appendChild(row);
    });
  });
};

/* ============================================================
   ADMIN – izdaje + članki + radio (MP3) + obvestila
============================================================ */
window.openAdmin = async function(){
  let isAdmin = false;
  if (auth.currentUser) {
    try {
      const u = await getDoc(doc(db, 'users',auth.currentUser.uid));
      isAdmin = u.exists() && u.data().role === 'admin';
    } catch (e) { console.warn('Admin check failed:', e); }
  }
  if (!isAdmin) {
    stage.innerHTML = `<div class="glass" style="padding:16px">⛔ Dostop zavrnjen.</div>`;
    return;
  }

  stage.innerHTML = `
    <div class="glass" style="padding:12px;display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">🛠️ Admin panel</div>
      <button class="btn ghost" id="backBtn">Nazaj</button>
    </div>

    <div class="wrap" style="padding:0">
      <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start">

        <!-- IZDAJE -->
        <div class="glass" style="flex:1;min-width:320px;padding:12px">
          <h3 style="margin:0 0 8px 0">Izdaje</h3>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px;margin-bottom:8px">
            <input class="input" id="eTitle" placeholder="Naslov (npr. Jesen 2025)">
            <input class="input" id="eMonth" type="number" min="1" max="12" placeholder="Mesec (1-12)">
            <input class="input" id="eYear"  type="number" min="2000" max="2100" placeholder="Leto">
            <input class="input" id="eFrom"  type="month" placeholder="Aktivno od (YYYY-MM)">
            <input class="input" id="eTo"    type="month" placeholder="Aktivno do (YYYY-MM)">
            <input class="input" id="eDesc"  placeholder="Kratek opis">
            <button class="btn ok" id="addEdition">+ Ustvari izdajo</button>
          </div>
          <div id="edList" class="card" style="padding:8px"></div>
        </div>

        <!-- Članki -->
        <div class="glass" style="flex:1;min-width:360px;padding:12px">
          <h3 style="margin:0 0 8px 0">Članki</h3>
          <div id="admArts"></div>
        </div>

        <!-- Radio: skladbe (MP3 upload) -->
        <div class="glass" style="flex:1;min-width:360px;padding:12px">
          <h3 style="margin:0 0 8px 0">Radio – Skladbe (MP3)</h3>
          <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">
            <input class="input" id="rTitle" placeholder="Naslov skladbe">
            <input class="input" id="rDur" type="number" min="10" max="1200" value="180" placeholder="Trajanje (s)" style="max-width:140px">
            <input class="input" id="rFile" type="file" accept="audio/mpeg,audio/mp3" style="max-width:280px; padding:8px; background:#fff; color:#111">
            <button class="btn" id="addTrack">Dodaj</button>
          </div>

          <!-- Progress za MP3 upload -->
          <div id="upWrap" style="height:8px;background:#eee;border-radius:6px;overflow:hidden;margin-top:6px;display:none">
            <div id="upBar" style="height:100%;width:0%;background:#24c1ff;transition:width .15s linear"></div>
          </div>
          <div id="upTxt" style="font-size:12px;color:#234;margin-top:6px;display:none">Pripravljeno…</div>

          <div id="tracks" class="card" style="padding:8px;margin-top:8px"></div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <input class="input" id="repeat" type="number" min="1" value="1" style="max-width:120px">
            <button class="btn ok" id="publish">Objavi urnik</button>
          </div>
        </div>

        <!-- Radio: obvestila -->
        <div class="glass" style="flex:1;min-width:360px;padding:12px">
          <h3 style="margin:0 0 8px 0">Radio – Obvestila</h3>
          <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">
            <input class="input" id="nTitle" placeholder="Naslov obvestila">
            <input class="input" id="nDate" type="date" style="max-width:180px">
            <textarea class="ta" id="nText" placeholder="Vsebina..." style="height:80px"></textarea>
            <button class="btn" id="addNotice">Dodaj</button>
          </div>
          <div id="notices" class="card" style="padding:8px"></div>
        </div>
      </div>
    </div>
  `;
  backify();

  /* ============ IZDAJE ============ */
  const edList = document.getElementById('edList');
  document.getElementById('addEdition').onclick = async ()=>{
    const title = eTitle.value.trim();
    const month = parseInt(eMonth.value||'0',10);
    const year  = parseInt(eYear.value||'0',10);
    const activeFrom = eFrom.value || '';
    const activeTo   = eTo.value || '';
    const desc = eDesc.value.trim();
    if(!month || !year){ alert('Mesec in leto sta obvezna.'); return; }
    try{
      await addDoc(collection(db,'editions'),{
        title, month, year, activeFrom, activeTo, desc,
        published: true, created: serverTimestamp(), updated: serverTimestamp()
      });
      eTitle.value=eMonth.value=eYear.value=eFrom.value=eTo.value=eDesc.value='';
    }catch(e){ alert('Napaka pri ustvarjanju izdaje: '+e.message); }
  };

  const unsubEditions = onSnapshot(
    query(collection(db,'editions'), orderBy('year','desc'), orderBy('month','desc')),
    (snap)=>{
      edList.innerHTML='';
      snap.forEach(ed=>{
        const e=ed.data();
        const row=document.createElement('div');
        row.className='glass';
        row.style.cssText='padding:8px 10px;margin:6px 0;background:#fff;color:#0d1b2a';
        const title = e.title?.trim() || `Izdaja ${String(e.month).padStart(2,'0')}/${e.year}`;
        row.innerHTML = `
          <b>${title}</b> ${e.published?'<span class="badge ok">OBJAVLJENO</span>':'<span class="badge wait">SKRITO</span>'}
          <div style="color:#456">${e.desc||''}</div>
          <div style="font-size:12px;color:#567">${String(e.month).padStart(2,'0')}/${e.year} · ${e.activeFrom||''} – ${e.activeTo||''}</div>
          <div style="display:flex;gap:8px;margin-top:6px">
            <button class="btn" data-act="toggle">${e.published?'Skrij':'Objavi'}</button>
            <button class="btn" data-act="edit">Uredi</button>
            <button class="btn bad" data-act="del">Izbriši</button>
          </div>
        `;
        row.querySelector('[data-act="toggle"]').onclick = async ()=>{
          try{ await updateDoc(doc(db,'editions',ed.id), { published: !e.published, updated: serverTimestamp() }); }
          catch(err){ alert('Napaka: '+err.message); }
        };
        row.querySelector('[data-act="edit"]').onclick = async ()=>{
          const nt = (prompt('Nov naslov (pusti prazno za brez spremembe):', e.title||'') ?? (e.title||''));
          const nm = parseInt(prompt('Mesec (1-12):', String(e.month))||String(e.month),10)||e.month;
          const ny = parseInt(prompt('Leto:', String(e.year))||String(e.year),10)||e.year;
          try{ await updateDoc(doc(db,'editions',ed.id), { title:nt, month:nm, year:ny, updated: serverTimestamp() }); }
          catch(err){ alert('Napaka: '+err.message); }
        };
        row.querySelector('[data-act="del"]').onclick = async ()=>{
          if(!confirm('Res izbrišem izdajo? (Članki ostanejo, vendar brez dodeljene izdaje)')) return;
          try{ await deleteDoc(doc(db,'editions',ed.id)); }
          catch(err){ alert('Napaka: '+err.message); }
        };
        edList.appendChild(row);
      });
    },
    (err)=> edList.innerHTML = `<div class="glass" style="padding:8px;background:#fff;color:#0d1b2a">Napaka: ${err.message}</div>`
  );

 /* ============ ČLANKI ============ */
const admArts = document.getElementById('admArts');
admArts.innerHTML = `
  <div class="card" style="padding:10px">
    <h4 style="margin:6px 0">Neobdelani (neobjavljeni)</h4>
    <div id="unpub"></div>
  </div>
  <div class="card" style="padding:10px;margin-top:10px">
    <h4 style="margin:6px 0">Objavljeni po izvodih</h4>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <select id="admEditionPick" class="sel" style="max-width:360px"></select>
      <button class="btn" id="makeNewspaper">📰 Sestavi časopis</button>
      <button class="btn ok" id="editNewspaper" style="display:none">Uredi & Objavi časopis</button>
    </div>
    <div id="pubList" style="margin-top:8px"></div>
  </div>
`;

const unpubEl = document.getElementById('unpub');
const pubList = document.getElementById('pubList');
const edPick  = document.getElementById('admEditionPick');
const btnMake = document.getElementById('makeNewspaper');
const btnEdit = document.getElementById('editNewspaper');

let editionsIndex = [];
onSnapshot(
  query(collection(db,'editions'), orderBy('year','desc'), orderBy('month','desc')),
  (snap)=>{
    editionsIndex = [];
    edPick.innerHTML = '';
    snap.forEach(ed=>{
      const e = ed.data();
      const title = e.title?.trim() || `Izdaja ${String(e.month).padStart(2,'0')}/${e.year}`;
     editionsIndex.push({
  id: ed.id,
  title,
  month: e.month,
  year: e.year,
  hasPaper: !!(e.newspaperPublished || e.newspaperDraft) // pokaži “Uredi & Objavi” tudi za draft
});

      const opt = document.createElement('option');
      opt.value = ed.id; opt.textContent = title + (e.newspaperPublished?' — 📰 ima časopis':'');
      edPick.appendChild(opt);
    });
    btnEdit.style.display = editionsIndex.find(x=>x.id===edPick.value && x.hasPaper)?'inline-flex':'none';
    renderPublishedFor(edPick.value);
  }
);

edPick.onchange = ()=>{
 btnEdit.style.display = editionsIndex.find(x=>x.id===edPick.value && x.hasPaper)?'inline-flex':'none';
  renderPublishedFor(edPick.value);
};

// NEOBJAVLJENI
const unsubUnpub = onSnapshot(
  query(collection(db,'articles'), where('approved','==',false), orderBy('created','desc')),
  (snap)=>{
    unpubEl.innerHTML='';
    snap.forEach(s=>{
      const d=s.data();
      const row=document.createElement('div');
      row.className='glass'; row.style.cssText='padding:8px 10px;margin:6px 0;background:#fff;color:#0d1b2a';
      row.innerHTML = `
        <b>${d.title||'(brez naslova)'}</b> <span class="badge">NEOBJAVLJENO</span>
        <div style="color:#456">${d.desc||''}</div>
        <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap">
          <button class="btn ok"   data-act="approve">Objavi</button>
          <button class="btn"      data-act="edit">Uredi</button>
          <button class="btn bad"  data-act="del">Izbriši</button>
        </div>
      `;
      row.querySelector('[data-act="approve"]').onclick = async ()=>{ try{await updateDoc(doc(db,'articles',s.id),{approved:true});}catch(e){alert(e.message)} };
      row.querySelector('[data-act="edit"]').onclick    = async ()=>{ try{const snap=await getDoc(doc(db,'articles',s.id)); navigate('editor',{id:s.id,...snap.data()}); }catch(e){alert(e.message)} };
      row.querySelector('[data-act="del"]').onclick     = async ()=>{ if(!confirm('Res?'))return; try{await deleteDoc(doc(db,'articles',s.id));}catch(e){alert(e.message)} };
      unpubEl.appendChild(row);
    });
  }
);

// OBJAVLJENI V IZBRANI IZDAJI
async function renderPublishedFor(editionId){
  if(!editionId){ pubList.innerHTML='<i>Izberi izdajo.</i>'; return; }
  const edDoc = await getDoc(doc(db,'editions',editionId));
  const ed = edDoc.data()||{};
btnEdit.style.display = (ed.newspaperPublished || ed.newspaperDraft)?'inline-flex':'none';



  const qSnap = await getDocs(query(collection(db,'articles'), where('approved','==',true), where('editionId','==',editionId), orderBy('created','desc')));
  pubList.innerHTML = '';
  if(ed.newspaperPublished){
    const box = document.createElement('div');
    box.className='glass'; box.style.cssText='padding:8px 10px;margin:6px 0;background:#fff;color:#0d1b2a';
    box.innerHTML = `<b>📰 Časopis</b> — prikazan nad članki v tej izdaji`;
    pubList.appendChild(box);
  }
  if(qSnap.empty){
    const inf=document.createElement('div');
    inf.className='glass'; inf.style.cssText='padding:8px 10px;background:#fff;color:#0d1b2a';
    inf.textContent='Ni objavljenih člankov v tej izdaji.'; pubList.appendChild(inf); return;
  }
  qSnap.forEach(s=>{
    const d=s.data();
    const row=document.createElement('div');
    row.className='glass'; row.style.cssText='padding:8px 10px;margin:6px 0;background:#fff;color:#0d1b2a';
    row.innerHTML=`
      <b>${d.title}</b>
      <div style="color:#456">${d.desc||''}</div>
      <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap">
        <button class="btn"     data-act="edit">Uredi</button>
        <button class="btn bad" data-act="del">Izbriši</button>
      </div>
    `;
    row.querySelector('[data-act="edit"]').onclick = async ()=>{ try{const snap=await getDoc(doc(db,'articles',s.id)); navigate('editor',{id:s.id,...snap.data()}); }catch(e){alert(e.message)} };
    row.querySelector('[data-act="del"]').onclick  = async ()=>{ if(!confirm('Res izbrišem?'))return; try{await deleteDoc(doc(db,'articles',s.id)); renderPublishedFor(editionId);}catch(e){alert(e.message)} };
    pubList.appendChild(row);
  });
}

// SESTAVI ČASOPIS
// === [FIX] SESTAVI ČASOPIS ===
btnMake.onclick = async () => {
  const edId = edPick.value;
  if (!edId) return alert('Izberi izdajo.');

  const edRef = doc(db, 'editions', edId);
  const edSnap = await getDoc(edRef);
  if (!edSnap.exists()) return alert('Izdaja ne obstaja.');
  const ed = edSnap.data() || {};
  const humanTitle = ed.title?.trim() || `Izdaja ${String(ed.month).padStart(2,'0')}/${ed.year}`;

  // 1) preberi objavljene članke za izdajo
  const aSnap = await getDocs(
    query(
      collection(db,'articles'),
      where('approved','==',true),
      where('editionId','==',edId),
      orderBy('created','asc')
    )
  );
  if (aSnap.empty) return alert('V izdaji ni objavljenih člankov.');

  const articles = [];
  aSnap.forEach(s => articles.push({ id: s.id, ...s.data() }));

  // 2) pripravi kazalo (H1/H2/H3 vseh člankov)
  const tocItems = [];
  for (const a of articles) {
    const html = String(a.content || '').split('<!--PAGE_BREAK-->').join('\n');
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    tmp.querySelectorAll('h1,h2,h3').forEach(h => {
      tocItems.push({
        level: h.tagName, 
        text: (h.textContent || '').trim()
      });
    });
  }

  // 3) naslovnica + kazalo
  const coverInner = `
    <h1 style="text-align:center;font-size:48px;margin-top:60px">DigiPiflarček</h1>
    <h2 style="text-align:center;margin-top:8px">${humanTitle}</h2>
    <p style="text-align:center;margin-top:30px;color:#456">${new Date().toLocaleDateString()}</p>
  `;
  const tocInner = `
    <h1>Kazalo</h1>
    <ul>
      ${tocItems.map(t => `
        <li style="margin-left:${t.level==='H2'?'16px':(t.level==='H3'?'32px':'0')}">${t.text}</li>
      `).join('')}
    </ul>
  `;

  // 4) strani časopisa (brez .page wrapperjev – editor jih sam doda)
  const pages = [
    coverInner,
    tocInner,
    ...articles.flatMap(a => String(a.content || '').split('<!--PAGE_BREAK-->'))
  ];

  const compiled = pages.join('<!--PAGE_BREAK-->');

  // 5) zapiši osnutek v editions/{id}
  await setDoc(edRef, {
    newspaperDraft: compiled,
    newspaperTitle: `DigiPiflarček — ${humanTitle}`,
    newspaperPublished: false,
    updated: serverTimestamp()
  }, { merge: true });

  // pokaži gumb za urejanje
  btnEdit.style.display = 'inline-flex';
  alert('Časopis sestavljen. Klikni "Uredi & Objavi časopis".');
};


// UREDI & OBJAVI ČASOPIS v urejevalniku
// === [FIX] UREDI & OBJAVI ČASOPIS ===
btnEdit.onclick = async () => {
  const edId = edPick.value;
  if (!edId) return;

  const edRef = doc(db, 'editions', edId);
  const edSnap = await getDoc(edRef);
  if (!edSnap.exists()) return alert('Izdaja ne obstaja.');
  const ed = edSnap.data() || {};

  const existing = {
    id: `edition-${edId}-paper`,
    title: ed.newspaperTitle || 'DigiPiflarček — Časopis',
    desc: 'Časopis — urejanje',
    content: ed.newspaperDraft || ed.newspaperHtml || ''
  };

  // odpri urejevalnik z namenskim gumbom "Objavi časopis"
  window.openEditorForNewspaper(edId, existing);
};



  /* ============ RADIO – MP3 ============ */
  const tracksEl = document.getElementById('tracks');
  let order = [];
  let tracks = [];
  const stateRef = doc(db, 'radioState', 'scheduler');

  document.getElementById('addTrack').onclick = async () => {
    const btn   = document.getElementById('addTrack');
    const fileI = document.getElementById('rFile');
    const title = (document.getElementById('rTitle').value || '').trim();
    const durIn = parseInt(document.getElementById('rDur').value || '180', 10);
    const file  = fileI.files && fileI.files[0];

    if (!title) { alert('Vnesi naslov skladbe.'); return; }
    if (!file)  { alert('Izberi MP3 datoteko.'); return; }

    btn.disabled = true;
    const upWrap = document.getElementById('upWrap');
    const upBar  = document.getElementById('upBar');
    const upTxt  = document.getElementById('upTxt');
    upWrap.style.display = 'block';
    upTxt.style.display  = 'block';
    upBar.style.width    = '0%';
    upTxt.textContent    = 'Začenjam…';

    try {
      const metadata = { contentType: file.type || 'audio/mpeg' };
      const path = `radioAudio/${Date.now()}_${file.name.replace(/\s+/g,'_')}`;
      const ref  = sRef(st, path);
      const uploadTask = uploadBytesResumable(ref, file, metadata);

      await new Promise((resolve, reject) => {
        uploadTask.on('state_changed',
          (snap) => {
            const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
            upBar.style.width = pct+'%';
            upTxt.textContent = `Nalaganje: ${pct}% (${(snap.bytesTransferred/1024/1024).toFixed(2)}MB / ${(snap.totalBytes/1024/1024).toFixed(2)}MB)`;
          },
          (err) => reject(err),
          () => resolve()
        );
      });

      const url = await getDownloadURL(ref);

      let durationSec = durIn;
      try {
        const probe = new Audio();
        probe.src = url;
        await new Promise((res, rej) => {
          probe.addEventListener('loadedmetadata', () => res(), { once:true });
          probe.addEventListener('error', () => rej(new Error('loadedmetadata error')), { once:true });
        });
        if (isFinite(probe.duration) && probe.duration > 0) {
          durationSec = Math.round(probe.duration);
        }
      } catch {}

      await addDoc(collection(db, 'radioTracks'), {
        title, url, path,
        durationSec: Math.max(10, Math.min(1200, durationSec)),
        approved: true,
        created: serverTimestamp()
      });

      upTxt.textContent = 'Končano ✔️';
      alert('Skladba dodana.');
      document.getElementById('rTitle').value = '';
      document.getElementById('rDur').value   = '180';
      fileI.value = '';

    } catch (e) {
      console.error('MP3 upload error', e);
      upTxt.textContent = 'Napaka ❌';
      const code = e?.code || '';
      if (code === 'storage/unauthorized') {
        alert('Nimaš dovoljenja za nalaganje v Storage. Preveri Storage Rules in da si prijavljen.');
      } else {
        alert('Napaka pri dodajanju skladbe: ' + (e?.message || e));
      }
    } finally {
      btn.disabled = false;
      setTimeout(() => {
        upWrap.style.display = 'none';
        upTxt.style.display  = 'none';
        upBar.style.width    = '0%';
        upTxt.textContent    = '';
      }, 800);
    }
  };

  const unsubTracks = onSnapshot(
    query(collection(db, 'radioTracks'), where('approved', '==', true)),
    (snap) => {
      tracks = snap.docs.map(d => {
        const x = d.data();
        const createdMs = x.created?.toMillis ? x.created.toMillis() : (x.created?.seconds ? x.created.seconds * 1000 : 0);
        return { id: d.id, createdMs, ...x };
      });
      tracks.sort((a, b) => a.createdMs - b.createdMs);
      renderTracks();
    },
    (err)=> alert('Napaka pri branju skladb: '+err.message)
  );

  const unsubState = onSnapshot(
    stateRef,
    (snap) => { order = snap.exists() ?(snap.data().order || []) : []; renderTracks(); },
    (err)=> alert('Napaka pri branju urnika: '+err.message)
  );

  function renderTracks() {
    const map = Object.fromEntries(tracks.map(t => [t.id, t]));
    order = order.filter(id => map[id]);
    tracks.forEach(t => { if (!order.includes(t.id)) order.push(t.id); });

    tracksEl.innerHTML = '';
    order.forEach((id, idx) => {
      const t = map[id];
      const row = document.createElement('div');
      row.className = 'glass';
      row.style.cssText = 'padding:8px 10px;margin:6px 0;background:#fff;color:#0d1b2a;display:flex;align-items:center;gap:8px';
      row.draggable = true; row.dataset.id = id;
      row.innerHTML = `
        <span style="width:28px;text-align:right;color:#777">${idx + 1}.</span>
        <span style="flex:1">${t.title}</span>
        <button class="btn"     data-act="dup">Podvoji</button>
        <button class="btn"     data-act="ins">Vstavi po…</button>
        <button class="btn bad" data-act="rm">Odstrani</button>
      `;
      row.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', id); row.style.opacity = '.5'; });
      row.addEventListener('dragend',   () => { row.style.opacity = '1'; });
      row.addEventListener('dragover',  e => { e.preventDefault(); row.style.outline = '2px dashed #24c1ff'; });
      row.addEventListener('dragleave', () => { row.style.outline = 'none'; });
      row.addEventListener('drop',      e => {
        e.preventDefault(); row.style.outline = 'none';
        const dragId = e.dataTransfer.getData('text/plain'); if (dragId === id) return;
        const from = order.indexOf(dragId), to = order.indexOf(id);
        order.splice(from, 1); order.splice(to, 0, dragId);
        renderTracks();
      });
      row.querySelector('[data-act="dup"]').onclick = () => { const pos = order.indexOf(id); order.splice(pos + 1, 0, id); renderTracks(); };
      row.querySelector('[data-act="ins"]').onclick = () => {
        const after = parseInt(prompt(`Vstavi po katerem mestu? (1…${order.length})`, String(idx + 1)) || String(idx + 1), 10);
        const pos = Math.max(1, Math.min(order.length, after));
        order.splice(pos, 0, id); renderTracks();
      };
      row.querySelector('[data-act="rm"]').onclick = () => { order = order.filter(x => x !== id); renderTracks(); };
      tracksEl.appendChild(row);
    });
  }

  document.getElementById('publish').onclick = async () => {
    try {
      const repeat = Math.max(1, parseInt(document.getElementById('repeat').value || '1', 10));
      await setDoc(stateRef, {
        order,
        repeatPerDay: repeat,
        baseStartAt: serverTimestamp(),
        playing: true,
        dayKey: new Date().toISOString().slice(0, 10)
      }, { merge: true });
      alert('Urnik objavljen.');
    } catch (e) { alert('Napaka pri objavi urnika: ' + e.message); }
  };

  /* ============ RADIO – obvestila ============ */
  const noticesEl = document.getElementById('notices');
  document.getElementById('addNotice').onclick = async () => {
    const title = nTitle.value.trim() || 'Obvestilo';
    const text  = nText.value.trim();
    const dateISO = nDate.value || null;
    if (!text) return alert('Vsebina obvestila je prazna.');
    try {
      await addDoc(collection(db, 'radioAnnouncements'), {
        title, text, dateISO,
        approved: false, created: serverTimestamp(),
        by: auth.currentUser.email
      });
      nTitle.value = ''; nText.value = ''; nDate.value = '';
    } catch (e) { alert('Napaka pri dodajanju obvestila: ' + e.message); }
  };

  const unsubNotices = onSnapshot(
    query(collection(db, 'radioAnnouncements'), orderBy('created', 'desc')),
    (snap) => {
      noticesEl.innerHTML = '';
      snap.forEach((s) => {
        const d = s.data();
        const row = document.createElement('div');
        row.className = 'glass';
        row.style.cssText = 'padding:8px 10px;margin:6px 0;background:#fff;color:#0d1b2a';
        row.innerHTML = `
          <b>${d.title}</b> ${badge(d.approved)}
          <div style="color:#456">${(d.text || '').slice(0, 140)}${(d.text || '').length > 140 ? '…' : ''}</div>
          <div style="font-size:12px;color:#567">${d.dateISO || ''}</div>
          <div style="display:flex;gap:8px;margin-top:6px">
            <button class="btn ok"  data-id="${s.id}" data-act="ap">Objavi</button>
            <button class="btn"     data-id="${s.id}" data-act="ed">Uredi</button>
            <button class="btn bad" data-id="${s.id}" data-act="rm">Izbriši</button>
          </div>
        `;
        row.querySelector('[data-act="ap"]').onclick = async () => {
          try { await updateDoc(doc(db, 'radioAnnouncements', s.id), { approved: true }); }
          catch (e) { alert('Napaka pri objavi obvestila: ' + e.message); }
        };
        row.querySelector('[data-act="rm"]').onclick = async () => {
          if (!confirm('Res izbrišem obvestilo?')) return;
          try { await deleteDoc(doc(db, 'radioAnnouncements', s.id)); }
          catch (e) { alert('Napaka pri brisanju obvestila: ' + e.message); }
        };
        row.querySelector('[data-act="ed"]').onclick = async () => {
          const nt = prompt('Novo besedilo obvestila:', d.text || '');
          if (nt == null) return;
          try { await updateDoc(doc(db, 'radioAnnouncements', s.id), { text: nt }); }
          catch (e) { alert('Napaka pri urejanju obvestila: ' + e.message); }
        };
        noticesEl.appendChild(row);
      });
    },
    (err)=> alert('Napaka pri branju obvestil: '+err.message)
  );

  const cleanup = ()=>{ try{unsubArticles();}catch{} try{unsubTracks();}catch{} try{unsubState();}catch{} try{unsubNotices();}catch{} try{unsubEditions();}catch{} };
  window.addEventListener('popstate', cleanup, { once:true });
};

/* ============================================================
   RADIO stran (uporabnik)
============================================================ */
window.openRadio = function(){
  stage.innerHTML = `
    <div class="glass" style="padding:12px;display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">📻 Šolski radio</div>
      <button class="btn ghost" id="backBtn">Nazaj</button>
    </div>
    <div class="wrap" style="padding:0">
      <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start">
        <div class="glass" style="flex:1;min-width:320px;padding:12px">
          <h3 style="margin:0 0 8px 0">Obvestila</h3>
          <div id="noticeList"></div>
        </div>
        <div class="glass" style="flex:1;min-width:360px;padding:12px">
          <h3 style="margin:0 0 8px 0">Spored</h3>
          <div id="queue"></div>
          <div style="margin-top:8px;color:#cfe7ff">Predvajanje: okrogel gumb zgoraj desno (play/pause).</div>
        </div>
      </div>
    </div>
  `;
  backify();
  const qEl=document.getElementById('queue');
  const nEl=document.getElementById('noticeList');

  (async()=>{
    const stDoc=await getDoc(doc(db,'radioState','scheduler'));
    if(!stDoc.exists()) qEl.innerHTML='<i>Urnik še ni objavljen.</i>';
    else{
      let ord=[...(stDoc.data().order||[])];
      qEl.innerHTML='';
      for(let i=0;i<ord.length;i+=10){
        const part=ord.slice(i,i+10);
        const snap=await getDocs(query(collection(db,'radioTracks'), where(documentId(),'in',part)));
        const byId={}; snap.forEach(d=>byId[d.id]=d.data());
        part.forEach(id=>{
          const t=byId[id]; if(!t) return;
          const row=document.createElement('div');
          row.className='glass'; row.style.cssText='padding:8px 10px;margin:6px 0;background:#fff;color:#0d1b2a';
          row.textContent=t.title||'Skladba'; qEl.appendChild(row);
        });
      }
    }
  })();

  onSnapshot(query(collection(db,'radioAnnouncements'), where('approved','==',true), orderBy('created','desc')), (snap)=>{
    nEl.innerHTML=''; snap.forEach(s=>{
      const d=s.data(); const box=document.createElement('div'); box.className='glass';
      box.style.cssText='padding:8px 10px;margin:6px 0;background:#fff;color:#0d1b2a';
      box.innerHTML = `<b>${d.title}</b> <small style="color:#567">${d.dateISO||''}</small><br>${(d.text||'').replace(/\n/g,'<br>')}`;
      nEl.appendChild(box);
    });
  });
};

/* ---------------- App init ---------------- */
function enterApp(){
  // gostu tudi pokažemo navbar
  authBox.style.display='none';
  navBar.style.display='flex';
  navigate('home',{},false);
}

onAuthStateChanged(auth, async (u)=>{
  if(u){ authBox.style.display='none'; navBar.style.display='flex'; await refreshAdminButton(); navigate('home',{},false); }
  else { navBar.style.display='none'; authBox.style.display='block'; stage.innerHTML=''; }
});

if(location.hash.startsWith('#issue-')){ const id=location.hash.split('-')[1]; navigate('issue',{id}); }
else if(location.hash==='#chat') window.openChat();
else if(location.hash==='#radio') window.openRadio();
else if(location.hash==='#profile') window.openProfile();
else if(location.hash==='#admin') window.openAdmin();
else window.openEditions();
</script>
</body>
</html>

