<!DOCTYPE html>
<html lang="sl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Urejevalnik</title>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Word‑like Editor (Ribbon, DOCX Import)</title>

  <!-- Mammoth for DOCX import -->
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

  <style>
    :root{
      --bg:#ffffff;
      --fg:#0b1f2a;
      --muted:#4a5568;
      --line:rgba(0,0,0,.10);
      --soft:rgba(0,0,0,.04);
      --accent:#2b6cb0;
      --accent-weak:#e6f0ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;}

    /* App bar */
    .topbar{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; gap:12px;
      padding:10px 14px;
      background:rgba(255,255,255,.9);
      backdrop-filter:saturate(1.05) blur(8px);
      border-bottom:1px solid var(--line);
    }
    .brand{font-weight:800; letter-spacing:.2px}
    .filename{border:1px solid var(--line); border-radius:10px; padding:6px 10px; min-width:220px}

    /* Ribbon */
    .ribbon{position:sticky; top:48px; z-index:45; background:rgba(255,255,255,.95);
            border-bottom:1px solid var(--line); box-shadow:0 8px 20px rgba(0,0,0,.06);}
    .tabs{display:flex; gap:6px; padding:8px 12px; border-bottom:1px solid var(--soft)}
    .tab{padding:8px 10px; border-radius:8px; font-weight:700; cursor:pointer; user-select:none; color:#123;}
    .tab.active{background:var(--accent-weak); border:1px solid #cfe1ff;}
    .panel{display:none; padding:8px 12px;}
    .panel.active{display:flex; flex-wrap:wrap; gap:12px;}
    .group{display:flex; align-items:center; gap:8px; padding:8px 12px; border:1px solid var(--soft); border-radius:12px; background:#fff}
    .r-label{font-size:12px; color:var(--muted); margin-right:2px}
    .btn, .sel, .inp{
      appearance:none; background:#fff; border:1px solid #cfe1ff; border-radius:10px; padding:8px 10px; cursor:pointer;
      font:inherit; color:inherit;
    }
    .btn:hover{background:#f5fbff}
    .sel{padding-right:28px}
    .split{width:1px;height:28px;background:var(--line);margin:0 4px}

    /* Stage */
    .stage{display:flex; gap:18px; padding:16px; align-items:flex-start}
    .pages{margin:0 auto; padding:24px 0; width:100%; max-width:1024px}
    .page{
      width:210mm; min-height:297mm; margin:18px auto; background:#fff; box-shadow:0 6px 24px rgba(0,0,0,.10);
      padding:20mm; border-radius:2px; outline:none; position:relative;
    }
    .page[contenteditable="true"]:focus{box-shadow:0 6px 24px rgba(0,0,0,.14), 0 0 0 3px #e6f0ff;}
    .page p{margin:.4rem 0; line-height:1.45}
    .srch{background: #fffd86}

    /* Footer bar */
    .footer{position:sticky; bottom:0; display:flex; gap:12px; justify-content:center; padding:10px 12px;
            border-top:1px solid var(--line); background:rgba(255,255,255,.92); backdrop-filter:blur(6px);}
  </style>

<style>
  /* Meta sidebar */
  .meta-wrap{position:sticky; top:8px; align-self:flex-start}
  .meta-card{background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:14px; padding:12px; box-shadow:0 6px 18px rgba(0,0,0,.06); width:280px}
  .meta-card label{font-size:12px; color:#456; display:block; margin-top:8px}
  .meta-card input, .meta-card textarea, .meta-card select{width:100%; padding:10px; border:1px solid #cfe1ff; border-radius:10px}
  .meta-actions{display:flex; gap:8px; margin-top:10px}
  .meta-actions .btn{flex:1}
  .stage{gap:18px}
  .toast{position:fixed; bottom:16px; right:16px; background:#0b1f2a; color:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 10px 28px rgba(0,0,0,.25); display:none}
</style>


<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

(() => {
  try{
    const stored = sessionStorage.getItem('fb_options');
    if (stored && getApps().length === 0) {
      const opts = JSON.parse(stored);
      const app = initializeApp(opts);
      // Expose globals like in test.html
      window.db = getFirestore(app);
      window.auth = getAuth(app);
    }
  }catch(e){ /* ignore */ }
})();
</script>


<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getStorage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

// Built-in Firebase fallback (uses same config as viewer) if sessionStorage isn't set
(() => {
  try {
    const hasGlobals = !!(window.db && window.auth);
    const hasStored  = !!sessionStorage.getItem('fb_options');
    if (!hasGlobals && !hasStored) {
      const firebaseConfig = {

  apiKey: "AIzaSyBQaD0MGnuMa45hm_99VvOwNsTdCoFPgNI",
  authDomain: "school-12a1f.firebaseapp.com",
  projectId: "school-12a1f",
  storageBucket: "school-12a1f.firebasestorage.app",
  messagingSenderId: "539327102547",
  appId: "1:539327102547:web:bd2571f5d327faafaed0a6",
  measurementId: "G-GBG9YCLE12"

      };
      if (getApps().length === 0) {
        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        window.storage = getStorage(app);
      }
    }
  } catch(e) {}
})();
</script>


<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getStorage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

(function ensureFirebase(){
  try{
    // If no app yet, prefer sessionStorage config; else, use provided firebaseConfig fallback
    let opts = null;
    const stored = sessionStorage.getItem('fb_options');
    if (stored) {
      opts = JSON.parse(stored);
    } else {
      // Hardcoded fallback (provided by user)
      opts = {
        apiKey: "AIzaSyBQaD0MGnuMa45hm_99VvOwNsTdCoFPgNI",
        authDomain: "school-12a1f.firebaseapp.com",
        databaseURL: "https://school-12a1f-default-rtdb.firebaseio.com",
        projectId: "school-12a1f",
        storageBucket: "school-12a1f.firebasestorage.app",
        messagingSenderId: "539327102547",
        appId: "1:539327102547:web:bd2571f5d327faafaed0a6",
        measurementId: "G-GBG9YCLE12"
      };
    }
    if (getApps().length === 0 && opts){
      const app = initializeApp(opts);
      window.db = getFirestore(app);
      window.auth = getAuth(app);
      window.storage = getStorage(app);
    } else {
      // Even if app exists, ensure globals
      try{
        const app = getApps()[0];
        window.db = window.db || getFirestore(app);
        window.auth = window.auth || getAuth(app);
        window.storage = window.storage || getStorage(app);
      }catch{}
    }
  }catch(e){ console.warn('Firebase init failed', e); }
})();
</script>


<style>
/* === Floating image system === */
.page { position: relative; }
.img-float {
  position: absolute; 
  cursor: move;
  box-shadow: 0 2px 10px rgba(0,0,0,.12);
  border: 1px solid transparent;
  user-select: none;
}
.img-float.selected { border-color: #5aa3ff; }
.img-float .resize {
  position: absolute; width: 10px; height: 10px; background: #5aa3ff; border-radius: 2px;
  border: 1px solid white; box-shadow: 0 0 0 1px rgba(0,0,0,.15);
}
.img-float .resize.ne { top:-6px; right:-6px; cursor: nesw-resize; }
.img-float .resize.nw { top:-6px; left:-6px; cursor: nwse-resize; }
.img-float .resize.se { bottom:-6px; right:-6px; cursor: nwse-resize; }
.img-float .resize.sw { bottom:-6px; left:-6px; cursor: nesw-resize; }
.img-float img { display:block; pointer-events:none; }
.page.overflowing { outline: 2px dashed rgba(255,0,0,.4); }
</style>

</head>
<body>

  <div class="topbar">
    <div class="brand">✍️ Urejevalnik</div>
    <input class="filename" id="fileName" value="Brez naslova"/>
    <button class="btn" id="btnNewPage">Nova stran</button>
    <button class="btn" id="btnSaveHtml">Shrani kot HTML</button>
    <button class="btn" id="btnPrint">Natisni / PDF</button>
  </div>

  <div class="ribbon" id="ribbon">
    <div class="tabs">
      <div class="tab active" data-tab="home">Osnovno</div>
      <div class="tab" data-tab="insert">Vstavljanje</div>
      <div class="tab" data-tab="layout">Postavitev</div>
      <div class="tab" data-tab="review">Pregled</div>
      <div class="tab" data-tab="view">Pogled</div>
    </div>

    <div class="panel active" data-panel="home">
      <div class="group">
        <span class="r-label">Pisava</span>
        <select class="sel" id="fontName">
          <option value="inherit">System</option>
          <option>Arial</option><option>Calibri</option><option>Cambria</option>
          <option>Georgia</option><option>Times New Roman</option><option>Verdana</option>
        </select>
        <select class="sel" id="fontSize">
          <option value="2">10</option><option value="3" selected>12</option>
          <option value="4">14</option><option value="5">18</option><option value="6">24</option>
          <option value="7">32</option>
        </select>
        <input class="inp" type="color" id="foreColor" title="Barva besedila"/>
        <input class="inp" type="color" id="backColor" title="Ozadje besedila"/>
        <button class="btn" data-cmd="bold"><b>B</b></button>
        <button class="btn" data-cmd="italic"><i>I</i></button>
        <button class="btn" data-cmd="underline"><u>U</u></button>
        <button class="btn" data-cmd="strikeThrough">S</button>
      </div>

      <div class="group">
        <button class="btn" data-cmd="insertUnorderedList">• Seznam</button>
        <button class="btn" data-cmd="insertOrderedList">1. Seznam</button>
        <button class="btn" data-cmd="outdent">Outdent</button>
        <button class="btn" data-cmd="indent">Indent</button>
        <div class="split"></div>
        <button class="btn" data-cmd="justifyLeft">Levo</button>
        <button class="btn" data-cmd="justifyCenter">Sredina</button>
        <button class="btn" data-cmd="justifyRight">Desno</button>
        <button class="btn" data-cmd="justifyFull">Poravnaj</button>
      </div>

      <div class="group">
        <select class="sel" id="heading">
          <option value="P">Navadno</option>
          <option value="H1">Naslov 1</option>
          <option value="H2">Naslov 2</option>
          <option value="H3">Naslov 3</option>
        </select>
      </div>
    </div>

    <div class="panel" data-panel="insert">
      <div class="group">
        <button class="btn" id="insertLink">Povezava</button>
        <button class="btn" id="insertImage">Slika</button><input type="file" id="imageFile" accept="image/*" style="display:none"/>
        <button class="btn" id="insertTable">Tabela</button>
        <button class="btn" id="pageBreak">Prelom strani</button>
      </div>
      <div class="group">
        <input type="file" id="docxInput" accept=".docx" style="display:none"/>
        <button class="btn" id="importDocx">Uvozi DOCX</button>
      </div>
    </div>

    <div class="panel" data-panel="layout">
      <div class="group">
        <button class="btn" id="marginNormal">Običajni robovi</button>
        <button class="btn" id="marginNarrow">Ozki robovi</button>
        <div class="split"></div>
        <button class="btn" id="oneCol">1 stolpec</button>
        <button class="btn" id="twoCol">2 stolpca</button>
      </div>
    </div>

    <div class="panel" data-panel="review">
      <div class="group">
        <button class="btn" id="findBtn">Najdi</button>
        <button class="btn" id="replaceBtn">Zamenjaj</button>
        <button class="btn" id="clearFmt">Počisti oblikovanje</button>
      </div>
    </div>

    <div class="panel" data-panel="view">
      <div class="group">
        <button class="btn" id="zoomPlus">Zoom +</button>
        <button class="btn" id="zoomMinus">Zoom −</button>
        <button class="btn" id="togglePrintGuides">Vodiči tiskanja</button>
      </div>
    </div>
  </div>

  <div class="stage">
<!-- Meta Sidebar -->
<div class="meta-wrap">
  <div class="meta-card">
    <div style="font-weight:900;margin-bottom:6px">Podatki članka</div>
    <label>Naslov</label>
    <input id="metaTitle" placeholder="Naslov članka"/>
    <label>Opis (max 150)</label>
    <textarea id="metaDesc" maxlength="150" rows="3" placeholder="Kratek opis…"></textarea>
    <label>Izdaja</label>
    <select id="metaEdition"></select>
    <label>Naslovna slika</label>
    <input id="metaHero" type="file" accept="image/*"/>
    <div id="metaHeroMsg" style="font-size:12px;color:#456;margin-top:4px"></div>
    <div class="meta-actions">
      <button class="btn" id="btnSaveArticle">💾 Shrani</button>
      <button class="btn" id="btnBack">Nazaj</button>
    </div>
  </div>
</div>
<div class="toast" id="toast"></div>

    <div class="pages" id="pages"></div>
  </div>

  <div class="footer">
    <span id="status">Pripravljeno</span>
  </div>

<script>
(function(){
  const pages = document.getElementById('pages');
  const status = document.getElementById('status');
  let scale = 1;

  // Helpers
  function exec(cmd, val=null){ document.execCommand(cmd, false, val); }
  function activePage(){
    const sel = document.getSelection();
    if(!sel || !sel.anchorNode) return pages.lastElementChild || null;
    let n = sel.anchorNode.nodeType===1 ? sel.anchorNode : sel.anchorNode.parentElement;
    return n ? n.closest('.page') : (pages.lastElementChild || null);
  }
  function newPage(html='<p>&nbsp;</p>'){
    const d = document.createElement('div');
    d.className='page'; d.contentEditable='true'; d.innerHTML=html;
    pages.appendChild(d); d.focus();
    return d;
  }
  function ensurePage(){ return activePage() || newPage(); }
  function setStatus(msg){ status.textContent = msg; }

  // Initial page
  newPage('<p>Začni pisati...</p>');

  // Tabs
  const ribbon = document.getElementById('ribbon');
  ribbon.querySelectorAll('.tab').forEach(tab=>{
    tab.addEventListener('click', ()=>{
      ribbon.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      ribbon.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
      tab.classList.add('active');
      const id = tab.getAttribute('data-tab');
      const panel = ribbon.querySelector('.panel[data-panel="'+id+'"]');
      if(panel) panel.classList.add('active');
    });
  });

  // Home actions
  document.querySelectorAll('[data-cmd]').forEach(b=>{
    b.addEventListener('click', ()=> exec(b.getAttribute('data-cmd')));
  });
  document.getElementById('heading').addEventListener('change', e=>{
    exec('formatBlock', e.target.value==='P' ? 'p' : e.target.value);
  });
  document.getElementById('fontName').addEventListener('change', e=> exec('fontName', e.target.value));
  document.getElementById('fontSize').addEventListener('change', e=> exec('fontSize', e.target.value));
  document.getElementById('foreColor').addEventListener('change', e=> exec('foreColor', e.target.value));
  document.getElementById('backColor').addEventListener('change', e=> exec('hiliteColor', e.target.value));

  // Insert actions
  document.getElementById('insertLink').addEventListener('click', ()=>{
    const url = prompt('URL:');
    if(url) exec('createLink', url);
  });
  const imgInput = document.getElementById('imageFile');
  document.getElementById('insertImage').addEventListener('click', ()=> imgInput.click());
  imgInput.addEventListener('change', async (e)=>{
    const f = e.target.files && e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      const dataUrl = reader.result;
      const p = ensurePage();
      const img = document.createElement('img');
      img.src = dataUrl; img.style.maxWidth = '100%';
      const sel = document.getSelection();
      if(sel && sel.rangeCount){
        const r = sel.getRangeAt(0); r.insertNode(img);
      }else{
        p.appendChild(img);
      }
      setStatus('Slika vstavljena.');
    };
    reader.readAsDataURL(f);
    e.target.value='';
  });

  document.getElementById('insertTable').addEventListener('click', ()=>{
    const rows = parseInt(prompt('Vrstice:', '3'),10) || 3;
    const cols = parseInt(prompt('Stolpci:', '3'),10) || 3;
    const table = document.createElement('table');
    table.style.width='100%'; table.style.borderCollapse='collapse';
    for(let r=0;r<rows;r++){
      const tr=document.createElement('tr');
      for(let c=0;c<cols;c++){
        const td=document.createElement('td'); td.innerHTML='&nbsp;';
        td.style.border='1px solid #ddd'; td.style.padding='6px';
        tr.appendChild(td);
      }
      table.appendChild(tr);
    }
    const sel = document.getSelection();
    const p = ensurePage();
    if(sel && sel.rangeCount){ sel.getRangeAt(0).insertNode(table); }
    else{ p.appendChild(table); }
    setStatus('Tabela vstavljena.');
  });

  document.getElementById('pageBreak').addEventListener('click', ()=>{
    newPage();
    setStatus('Dodana nova stran.');
  });

  // DOCX import
  const docxInput = document.getElementById('docxInput');
  document.getElementById('importDocx').addEventListener('click', ()=> docxInput.click());
  docxInput.addEventListener('change', async (e)=>{
    const f = e.target.files && e.target.files[0]; if(!f) return;
    try{
      const ab = await f.arrayBuffer();
      const res = await window.mammoth.convertToHtml({arrayBuffer: ab}, {
        convertImage: window.mammoth.images.inline(function(elem){
          return elem.read('base64').then(function(buffer){
            return { src: 'data:'+elem.contentType+';base64,'+buffer };
          });
        })
      });
      const html = res.value || '<p>(Prazno)</p>';
      const p = ensurePage();
      p.innerHTML = html;
      setStatus('DOCX uvožen.');
    }catch(err){
      console.error(err);
      alert('Napaka pri uvozu DOCX: '+ ((err && err.message) || ''));
    }finally{
      e.target.value='';
    }
  });

  // Layout
  document.getElementById('marginNormal').addEventListener('click', ()=>{
    pages.querySelectorAll('.page').forEach(p=> p.style.padding='20mm');
  });
  document.getElementById('marginNarrow').addEventListener('click', ()=>{
    pages.querySelectorAll('.page').forEach(p=> p.style.padding='12mm');
  });
  document.getElementById('oneCol').addEventListener('click', ()=>{
    const p = activePage(); if(!p) return;
    p.style.columnCount='1'; p.style.columnGap='0';
  });
  document.getElementById('twoCol').addEventListener('click', ()=>{
    const p = activePage(); if(!p) return;
    p.style.columnCount='2'; p.style.columnGap='14mm';
  });

  // Review
  function clearHighlights(node){
    node.querySelectorAll('mark.srch').forEach(m=>{
      const txt = document.createTextNode(m.textContent);
      m.parentNode.replaceChild(txt, m);
    });
  }
  document.getElementById('findBtn').addEventListener('click', ()=>{
    const q = prompt('Najdi:');
    const p = activePage(); if(!p || !q) return;
    clearHighlights(p);
    const rx = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'gi');
    p.innerHTML = p.innerHTML.replace(rx, m=> '<mark class="srch">'+m+'</mark>');
  });
  document.getElementById('replaceBtn').addEventListener('click', ()=>{
    const q = prompt('Najdi:');
    if(q===null) return;
    const r = prompt('Zamenjaj z:');
    if(r===null) return;
    const p = activePage(); if(!p) return;
    const rx = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'g');
    p.innerHTML = p.innerHTML.replace(rx, r);
  });
  document.getElementById('clearFmt').addEventListener('click', ()=>{
    exec('removeFormat'); exec('unlink');
  });

  // View
  function applyScale(){
    pages.style.transform = 'scale('+scale+')';
    pages.style.transformOrigin = '50% 0';
  }
  document.getElementById('zoomPlus').addEventListener('click', ()=>{ scale = Math.min(2, scale+0.1); applyScale(); });
  document.getElementById('zoomMinus').addEventListener('click', ()=>{ scale = Math.max(0.6, scale-0.1); applyScale(); });
  let guidesOn = false;
  document.getElementById('togglePrintGuides').addEventListener('click', ()=>{
    guidesOn = !guidesOn;
    pages.querySelectorAll('.page').forEach(p=> p.style.outline = guidesOn ? '1px dashed #aac8ff' : 'none');
  });

  // App bar actions
  document.getElementById('btnNewPage').addEventListener('click', ()=> newPage());
  document.getElementById('btnPrint').addEventListener('click', ()=> window.print());
  document.getElementById('btnSaveHtml').addEventListener('click', ()=>{
    const name = (document.getElementById('fileName').value || 'Dokument') + '.html';
    const full = '<!DOCTYPE html><html>'+document.documentElement.innerHTML+'</html>';
    const blob = new Blob([full], {type:'text/html;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = name; a.click();
    setTimeout(()=> URL.revokeObjectURL(a.href), 1500);
  });

})();
</script>


<script>
(function(){
  // Query params
  const params = new URLSearchParams(location.search);
  const articleId = params.get('id');
  const isNew = params.has('new');
  const editionParam = params.get('edition'); // optional preselect

  // UI refs (available after original script runs)
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  ready(async function(){
    const pages = document.getElementById('pages');
    const toast = document.getElementById('toast');
    const metaTitle = document.getElementById('metaTitle');
    const metaDesc  = document.getElementById('metaDesc');
    const metaEdition = document.getElementById('metaEdition');
    const metaHero = document.getElementById('metaHero');
    const metaHeroMsg = document.getElementById('metaHeroMsg');
    const btnSave = document.getElementById('btnSaveArticle');
    const btnBack = document.getElementById('btnBack');

    // Toast helper
    function showToast(msg){ toast.textContent = msg; toast.style.display='block'; setTimeout(()=> toast.style.display='none', 1800); }

    // Load editions (same Firebase)
    const hasFirebase = !!(window.db && window.auth);
    let heroURL = '';

    async function loadEditions(){
      if(!hasFirebase){ metaEdition.innerHTML='<option value=\"\">—</option>'; return; }
      const { collection, query, where, orderBy, getDocs } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
      const snap = await getDocs(query(collection(window.db,'editions'), where('published','==',true), orderBy('year','desc'), orderBy('month','desc')));
      metaEdition.innerHTML = '<option value=\"\">— izberi izdajo —</option>';
      snap.forEach(ed=>{
        const e=ed.data();
        const label = (e.title && e.title.trim()) || `Izdaja ${String(e.month).padStart(2,'0')}/${e.year}`;
        const opt=document.createElement('option'); opt.value=ed.id; opt.textContent=label; metaEdition.appendChild(opt);
      });
      if(editionParam) metaEdition.value = editionParam;
    }

    // Load article if editing
    async function loadArticle(){
      if(!hasFirebase || !articleId) return;
      const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
      const ref = doc(window.db, 'articles', articleId);
      const snap = await getDoc(ref);
      if(snap.exists()){
        const a = snap.data();
        metaTitle.value = a.title || '';
        metaDesc.value  = a.desc || '';
        metaEdition.value = a.editionId || '';
        heroURL = a.img || '';
        // Load content into first page
        const parts = String(a.content||'').split('<!--PAGE_BREAK-->');
        if(parts.length){
          pages.innerHTML = '';
          parts.forEach(h=>{
            const d=document.createElement('div'); d.className='page'; d.contentEditable='true'; d.innerHTML=h||'<p>&nbsp;</p>'; pages.appendChild(d);
          });
        }
      }
    }

    // Hero upload
    metaHero.addEventListener('change', async e=>{
      const f=e.target.files && e.target.files[0]; if(!f) return;
      try{
        if(hasFirebase){
          const { getStorage, ref, uploadBytes, getDownloadURL } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js");
          const st = getStorage();
          const rf = ref(st, 'articleImages/'+Date.now()+'_'+f.name.replace(/\s+/g,'_'));
          await uploadBytes(rf, f);
          heroURL = await getDownloadURL(rf);
          metaHeroMsg.textContent = 'Naloženo ✔️';
        }else{
          const rd = new FileReader(); rd.onload = ()=>{ heroURL = rd.result; metaHeroMsg.textContent='Uporabljena lokalna slika (data URL)'; }; rd.readAsDataURL(f);
        }
      }catch(err){ metaHeroMsg.textContent = 'Napaka: '+ ((err&&err.message)||''); }
    });

    // Save
    btnSave.addEventListener('click', async ()=>{
      const titleV = (metaTitle.value||'').trim();
      const descV  = (metaDesc.value||'').trim();
      const editionId = metaEdition.value||'';
      if(!titleV) return alert('Vnesi naslov.');
      if(!editionId) return alert('Izberi izdajo.');
      const content = [...pages.children].map(p=> p.innerHTML).join('<!--PAGE_BREAK-->');

      if(hasFirebase){
        const { collection, addDoc, serverTimestamp, doc, setDoc } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
        try{
          if(articleId){
            await setDoc(doc(window.db,'articles',articleId), { title:titleV, desc:descV, editionId, img: heroURL||'', content, created: serverTimestamp(), author: window.auth.currentUser?.uid || 'anon', approved:false });
          }else{
            await addDoc(collection(window.db,'articles'), { title:titleV, desc:descV, editionId, img: heroURL||'', content, created: serverTimestamp(), author: window.auth.currentUser?.uid || 'anon', approved:false });
          }
          showToast('Shranjeno ✔️');
          setTimeout(()=> history.back(), 600);
        }catch(err){ alert('Napaka pri shranjevanju: '+ ((err&&err.message)||'')); }
      }else{
        // Fallback: download
        const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([content],{type:'text/html;charset=utf-8'})); a.download=(titleV||'clanek')+'.html'; a.click();
        setTimeout(()=> URL.revokeObjectURL(a.href), 1500);
        history.back();
      }
    });

    // Back without saving
    btnBack.addEventListener('click', ()=> history.back());

    // Add 15 more tools on top of existing (to reach 30+):
    function addBtn(whereSel, id, label, handler){
      const where = document.querySelector(whereSel);
      if(!where) return;
      const b=document.createElement('button'); b.className='btn'; b.id=id; b.textContent=label; b.addEventListener('click', handler); where.appendChild(b);
    }
    const home1 = '.panel[data-panel="home"] .group';
    const insert1 = '.panel[data-panel="insert"] .group';
    const layout1 = '.panel[data-panel="layout"] .group';
    const review1 = '.panel[data-panel="review"] .group';
    const view1 = '.panel[data-panel="view"] .group';

    function exec(cmd,val=null){ try{ document.execCommand(cmd,false,val);}catch{} }
    function ensurePage(){
      return document.querySelector('.page') || (function(){
        const d=document.createElement('div'); d.className='page'; d.contentEditable='true'; d.innerHTML='<p>&nbsp;</p>'; pages.appendChild(d); return d;
      })();
    }
    function wrapSel(style){ const sel=document.getSelection(); if(!sel||sel.rangeCount===0||sel.isCollapsed) return; const r=sel.getRangeAt(0); const el=document.createElement('span'); el.setAttribute('style', style); el.appendChild(r.extractContents()); r.insertNode(el); }
    function insertHTML(html){ const sel=document.getSelection(); if(sel&&sel.rangeCount){ const r=sel.getRangeAt(0); r.deleteContents(); r.insertNode(r.createContextualFragment(html)); } else { ensurePage().insertAdjacentHTML('beforeend', html);} }

    // Extra functions:
    addBtn(home1,'btnSmallCaps','SmallCaps', ()=> wrapSel('font-variant: small-caps'));
    addBtn(home1,'btnClearFmt','Počisti oblikovanje', ()=> {exec('removeFormat'); exec('unlink');});
    addBtn(home1,'btnUpper','VELIKA', ()=>{ const s=window.getSelection(); if(s && s.toString()){ document.execCommand('insertText',false,s.toString().toUpperCase()); } });

    addBtn(insert1,'btnCallout','Kalout', ()=> insertHTML('<div style="border-left:4px solid #4f8; padding:8px; background:#f8fffb">Opomba…</div>'));
    addBtn(insert1,'btnEmoji','Emoji 🙂', ()=> insertHTML('🙂'));
    addBtn(insert1,'btnQuote','Citiraj', ()=> exec('formatBlock','blockquote'));
    addBtn(insert1,'btnCode','Inline code', ()=> wrapSel('font-family: ui-monospace, Menlo, Consolas, monospace; background:#f4f6fa; padding:2px 4px; border-radius:4px'));

    addBtn(layout1,'btnCols3','3 stolpci', ()=>{ const p=document.querySelector('.page'); if(p){ p.style.columnCount='3'; p.style.columnGap='10mm'; }});
    addBtn(layout1,'btnLine15','Razmik 1.5', ()=>{ const p=document.querySelector('.page'); if(p){ p.style.lineHeight='1.5'; }});
    addBtn(layout1,'btnLine2','Razmik 2.0', ()=>{ const p=document.querySelector('.page'); if(p){ p.style.lineHeight='1.8'; }});

    let guides=false;
    addBtn(view1,'btnGuides','Vodiči', ()=>{ guides=!guides; document.querySelectorAll('.page').forEach(p=> p.style.outline = guides ? '1px dashed #aac8ff' : 'none'); });
    addBtn(view1,'btnZoomReset','Zoom 100%', ()=>{ document.querySelector('.pages').style.transform='scale(1)'; });

    let marks=[], idx=-1;
    function clearMarks(){ document.querySelectorAll('mark.srch').forEach(m=>{ const t=document.createTextNode(m.textContent); m.parentNode.replaceChild(t,m); }); marks=[]; idx=-1; }
    addBtn(review1,'btnFind','Najdi', ()=>{
      const q = prompt('Najdi:');
      const p = document.querySelector('.page'); if(!p || !q) return;
      clearMarks();
      const rx = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'gi');
      p.innerHTML = p.innerHTML.replace(rx, m=> '<mark class="srch">'+m+'</mark>');
      marks = [...p.querySelectorAll('mark.srch')]; idx=-1; if(marks.length){ idx=0; marks[0].scrollIntoView({block:'center'}); }
    });
    addBtn(review1,'btnReplace','Zamenjaj', ()=>{
      const q = prompt('Najdi:');
      if(q===null) return; const r = prompt('Zamenjaj z:');
      if(r===null) return;
      document.querySelectorAll('.page').forEach(p=>{
        const rx = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g');
        p.innerHTML = p.innerHTML.replace(rx, r);
      });
    });
    addBtn(review1,'btnSelectAll','Select All', ()=> exec('selectAll'));
    addBtn(review1,'btnUndo','Undo', ()=> exec('undo'));
    addBtn(review1,'btnRedo','Redo', ()=> exec('redo'));

    // Load editions and article if needed
    await loadEditions();
    await loadArticle();
  });
})();
</script>


<script type="module">
/* ===== Robust loader: articles + submissions + editions (newspaper) ===== */
import { getApps, initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc, updateDoc, collection, addDoc, setDoc, serverTimestamp, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

async function ensureFirebase(){
  if (window.db && window.auth) return;
  let raw = sessionStorage.getItem('fb_options');
  if (!raw){
    // Ask opener (same-origin) for config
    try {
      window.addEventListener('message', (ev)=>{
        if(ev && ev.data && ev.data.type === 'fb_options' && ev.data.payload){
          sessionStorage.setItem('fb_options', JSON.stringify(ev.data.payload));
          location.reload();
        }
      }, { once:true });
      window.opener && window.opener.postMessage({type:'fb_options_request'}, location.origin);
    }catch(e){}
    // wait briefly then re-read
    await new Promise(r=> setTimeout(r, 200));
    raw = sessionStorage.getItem('fb_options');
  }
  if (!raw) return;
  const app = (getApps().length ? null : initializeApp(JSON.parse(raw))) || getApps()[0];
  window.db = getFirestore(app);
  window.auth = getAuth(app);
  window.storage = getStorage(app);
}

function pick(obj, keys){
  for(const k of keys){ if(obj && obj[k]!=null) return obj[k]; }
  return '';
}

function htmlFromRecord(a){
  // try multiple field names for content
  return String(pick(a, ['content','html','body','text','article','value','doc','document'])||'').trim();
}

function imageFromRecord(a){
  return pick(a, ['img','image','hero','heroUrl','cover','coverUrl']);
}

function setPagesFromHTML(html){
  const pages = document.getElementById('pages');
  if (!pages) return;
  pages.innerHTML = '';
  const parts = (html ? html.split('<!--PAGE_BREAK-->') : ['']);
  for(const h of parts){
    const d=document.createElement('div');
    d.className='page';
    d.contentEditable='true';
    d.innerHTML = (h && h.trim()) ? h : '<p>&nbsp;</p>';
    pages.appendChild(d);
  }
}

async function loadEditionsSelect(preselectId){
  const sel = document.getElementById('metaEdition');
  if(!sel || !window.db) return;
  try{
    const snap = await getDocs(query(collection(window.db,'editions'), where('published','==',true), orderBy('year','desc'), orderBy('month','desc')));
    sel.innerHTML = '<option value="">— izberi izdajo —</option>';
    snap.forEach(ed=>{
      const e=ed.data();
      const label = (e.title && e.title.trim()) || `Izdaja ${String(e.month).padStart(2,'0')}/${e.year}`;
      const opt=document.createElement('option'); opt.value=ed.id; opt.textContent=label; sel.appendChild(opt);
    });
    if (preselectId) sel.value = preselectId;
  }catch(e){
    sel.innerHTML = '<option value="">—</option>';
  }
}

async function loadExisting(){
  const params = new URLSearchParams(location.search);
  const articleId = params.get('id');
  const srcParam  = params.get('src') || ''; // may be 'articles' or 'submissions' or empty
  const editionId = params.get('edition');    // for newspaper editing
  const isNew     = params.has('new');

  await ensureFirebase();

  // Always populate editions select first
  await loadEditionsSelect(editionId || null);

  // If edition editing, load newspaperHtml from edition doc
  if (editionId && window.db){
    const ref = doc(window.db, 'editions', editionId);
    const snap = await getDoc(ref);
    if (snap.exists()){
      const ed = snap.data();
      document.getElementById('metaTitle').value = ed.newspaperTitle || ed.title || 'Časopis';
      document.getElementById('metaDesc').value  = ed.newspaperDesc || '';
      document.getElementById('metaEdition').value = editionId;
      const html = ed.newspaperHtml || '';
      setPagesFromHTML(html);
    } else {
      // if edition not found, still start blank but preselect edition
      document.getElementById('metaEdition').value = editionId;
      setPagesFromHTML('');
    }
    return; // edition flow handled
  }

  if (isNew || !articleId || !window.db){
    setPagesFromHTML('');
    return;
  }

  // Try to load by src hint first
  let loaded = null;
  async function tryLoad(collectionName){
    const ref = doc(window.db, collectionName, articleId);
    const snap = await getDoc(ref);
    if(snap.exists()){ return { data: snap.data(), from: collectionName }; }
    return null;
  }

  if (srcParam === 'articles') loaded = await tryLoad('articles');
  else if (srcParam === 'submissions') loaded = await tryLoad('submissions');

  // Fallback: try articles then submissions if not found or src unspecified
  if (!loaded) loaded = await tryLoad('articles');
  if (!loaded) loaded = await tryLoad('submissions');

  if (loaded){
    const a = loaded.data;
    document.getElementById('metaTitle').value   = pick(a, ['title','name','subject']) || '';
    document.getElementById('metaDesc').value    = pick(a, ['desc','description','summary']) || '';
    document.getElementById('metaEdition').value = pick(a, ['editionId','edition','editionRef']) || '';
    // remember hero
    const hero = imageFromRecord(a);
    if (hero){ 
      const msg = document.getElementById('metaHeroMsg'); 
      if (msg){ msg.textContent = 'Obstoječa slika naložena ✔️'; msg.dataset.url = hero; } 
    }
    const html = htmlFromRecord(a);
    setPagesFromHTML(html);
  } else {
    // not found -> blank
    setPagesFromHTML('');
  }
}

document.addEventListener('DOMContentLoaded', loadExisting);
</script>


<script type="module">
import { getApps, initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, collection, serverTimestamp, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

// Ensure Firebase is ready (from sessionStorage or fallback already injected)
async function ensureFB(){
  if (window.db && window.auth) return true;
  try{
    const raw = sessionStorage.getItem('fb_options');
    if (raw && getApps().length === 0){
      const app = initializeApp(JSON.parse(raw));
      window.db = getFirestore(app);
      window.auth = getAuth(app);
      window.storage = getStorage(app);
      return true;
    }
  }catch(e){}
  return !!(window.db && window.auth);
}

function $(id){ return document.getElementById(id); }
function pageHTML(){ return [...document.querySelectorAll('.page')].map(p=> p.innerHTML).join('<!--PAGE_BREAK-->'); }
function setPages(html){
  const pages = $("pages");
  pages.innerHTML='';
  (html ? html.split('<!--PAGE_BREAK-->') : ['']).forEach(h=>{
    const d=document.createElement('div'); d.className='page'; d.contentEditable='true'; d.innerHTML=h && h.trim()? h : '<p>&nbsp;</p>'; pages.appendChild(d);
  });
}

// Load Editions select
async function loadEditions(preselect){
  const sel = $("metaEdition"); if(!sel) return;
  if(!await ensureFB()){ sel.innerHTML='<option value=\"\">—</option>'; return; }
  try{
    const snap = await getDocs(query(collection(window.db,'editions'), where('published','==',true), orderBy('year','desc'), orderBy('month','desc')));
    sel.innerHTML = '<option value=\"\">— izberi izdajo —</option>';
    snap.forEach(ed=>{
      const e=ed.data();
      const label=(e.title && e.title.trim()) || `Izdaja ${String(e.month).padStart(2,'0')}/${e.year}`;
      const o=document.createElement('option'); o.value=ed.id; o.textContent=label; sel.appendChild(o);
    });
    if(preselect) sel.value = preselect;
  }catch{ sel.innerHTML='<option value=\"\">—</option>'; }
}

// Load existing record (articles / submissions / edition newspaper)
async function loadExisting(){
  const p = new URLSearchParams(location.search);
  const id = p.get('id'); const src = p.get('src') || 'articles'; const editionId = p.get('edition');
  await ensureFB();
  await loadEditions(editionId || null);

  // Edition / newspaper
  if(editionId){
    if(!(window.db)) return setPages('');
    const ref = doc(window.db,'editions', editionId);
    const s = await getDoc(ref);
    if(s.exists()){
      const ed = s.data();
      $("metaTitle").value = ed.newspaperTitle || ed.title || 'Časopis';
      $("metaDesc").value  = ed.newspaperDesc || '';
      $("metaEdition").value = editionId;
      setPages(ed.newspaperHtml || '');
    }else{
      $("metaEdition").value = editionId;
      setPages('');
    }
    return;
  }

  // New
  if(!id){ 
    const draft = localStorage.getItem('editor_draft');
    if(draft){
      try{
        const d = JSON.parse(draft);
        $("metaTitle").value = d.title||''; $("metaDesc").value=d.desc||''; $("metaEdition").value=d.editionId||''; setPages(d.content||'');
      }catch{ setPages(''); }
    }else setPages('');
    return;
  }

  // Load articles/submissions
  if(!(window.db)) return setPages('');
  async function getFrom(col){
    const r = doc(window.db,col,id); const s=await getDoc(r); return s.exists()? s.data() : null;
  }
  let data = null;
  if(src==='articles') data = await getFrom('articles');
  else if(src==='submissions') data = await getFrom('submissions');
  if(!data) data = await getFrom('articles');
  if(!data) data = await getFrom('submissions');

  if(data){
    $("metaTitle").value   = data.title || data.name || '';
    $("metaDesc").value    = data.desc || data.description || '';
    $("metaEdition").value = data.editionId || '';
    const hero = data.img || data.image || data.hero || '';
    if(hero){ const m=$("metaHeroMsg"); if(m){ m.textContent='Obstoječa slika ✔️'; m.dataset.url=hero; } }
    setPages((data.content || data.html || data.body || ''));
  }else{
    setPages('');
  }
}

// HERO upload → get URL
$("metaHero")?.addEventListener('change', async (e)=>{
  const f=e.target.files && e.target.files[0]; if(!f) return;
  if(!await ensureFB()){ const r=new FileReader(); r.onload=()=>{ $("metaHeroMsg").textContent='Lokalna slika (data URL)'; $("metaHeroMsg").dataset.url=r.result; }; r.readAsDataURL(f); return; }
  try{
    const st = (await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js"));
    const storage = st.getStorage();
    const rf = st.ref(storage, 'articleImages/'+Date.now()+'_'+f.name.replace(/\s+/g,'_'));
    await st.uploadBytes(rf, f);
    const url = await st.getDownloadURL(rf);
    $("metaHeroMsg").textContent='Naloženo ✔️'; $("metaHeroMsg").dataset.url = url;
  }catch(err){ $("metaHeroMsg").textContent='Napaka: '+(err?.message||err); }
});

// Explicit Save
$("btnSaveArticle")?.addEventListener('click', async ()=>{
  const p = new URLSearchParams(location.search);
  const id = p.get('id'); const src = p.get('src') || 'articles'; const editionId = p.get('edition');
  const title = ($("metaTitle").value||'').trim();
  const desc  = ($("metaDesc").value||'').trim();
  const edSel = $("metaEdition").value||'';
  const hero  = $("metaHeroMsg").dataset?.url || '';

  if(editionId){
    if(!await ensureFB()) return history.back();
    const ref = doc(window.db,'editions', editionId);
    await updateDoc(ref, { newspaperTitle: title||'Časopis', newspaperDesc: desc||'', newspaperHtml: pageHTML(), newspaperUpdated: serverTimestamp() });
    history.back(); return;
  }

  if(!await ensureFB()){
    // Fallback: download HTML
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([pageHTML()],{type:'text/html;charset=utf-8'})); a.download=(title||'clanek')+'.html'; a.click();
    setTimeout(()=> URL.revokeObjectURL(a.href), 1500);
    history.back(); return;
  }

  const payload = { title, desc, editionId: edSel, img: hero, content: pageHTML(), updated: serverTimestamp(), author: window.auth.currentUser?.uid || 'anon', approved: false };
  const { setDoc, addDoc, doc: ddoc, collection: coll } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");

  if(id){
    // Update existing (articles or submissions->articles)
    if(src==='submissions'){
      const aRef = await addDoc(coll(window.db,'articles'), { ...payload, created: serverTimestamp() });
      try{ await updateDoc(ddoc(window.db,'submissions', id), { processed: true, linkedArticleId: aRef.id }); }catch(e){}
    }else{
      await setDoc(ddoc(window.db,'articles', id), payload, { merge: true });
    }
  }else{
    // New article
    await addDoc(coll(window.db,'articles'), { ...payload, created: serverTimestamp() });
  }

  // Clear local draft and return
  localStorage.removeItem('editor_draft');
  history.back();
});

// AUTOSAVE (every 2s after changes).
// For new docs: localStorage draft. For existing docs: Firestore merge (except editions handled above).
(function autosave(){
  const pagesEl = $("pages");
  const inputs  = [$("metaTitle"), $("metaDesc"), $("metaEdition")].filter(Boolean);
  let t=null;
  function schedule(){ clearTimeout(t); t=setTimeout(run, 2000); }
  pagesEl?.addEventListener('input', schedule);
  inputs.forEach(i=> i.addEventListener('input', schedule));

  async function run(){
    const p = new URLSearchParams(location.search);
    const id = p.get('id'); const src = p.get('src') || 'articles'; const editionId = p.get('edition');
    const title = ($("metaTitle").value||'').trim();
    const desc  = ($("metaDesc").value||'').trim();
    const edSel = $("metaEdition").value||'';
    const hero  = $("metaHeroMsg").dataset?.url || '';

    // Edition autosave → update newspaperHtml
    if(editionId){
      if(await ensureFB()){
        try{
          await updateDoc(doc(window.db,'editions', editionId), { newspaperTitle: title||'Časopis', newspaperDesc: desc||'', newspaperHtml: pageHTML(), newspaperUpdated: serverTimestamp() });
        }catch{}
      }
      return;
    }

    // Existing article → Firestore merge
    if(id && await ensureFB()){
      try{
        await setDoc(doc(window.db,'articles', id), { title, desc, editionId: edSel, img: hero, content: pageHTML(), updated: serverTimestamp() }, { merge: true });
      }catch{}
      return;
    }

    // New → local draft
    const draft = { title, desc, editionId: edSel, content: pageHTML(), hero };
    localStorage.setItem('editor_draft', JSON.stringify(draft));
  }
})();

// INITIAL LOAD
document.addEventListener('DOMContentLoaded', loadExisting);
</script>


<script type="module">
import { doc, getDoc, setDoc, updateDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getDownloadURL, getStorage, ref, uploadBytes } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

(function(){
  const params = new URLSearchParams(location.search);
  const articleId = params.get('id');
  const src = params.get('src') || 'articles';
  const editionIdParam = params.get('edition');
  let dirty = false;
  let heroURL = '';
  const pages = document.getElementById('pages');
  const metaTitle = document.getElementById('metaTitle');
  const metaDesc  = document.getElementById('metaDesc');
  const metaEdition = document.getElementById('metaEdition');
  const metaHero = document.getElementById('metaHero');
  const metaHeroMsg = document.getElementById('metaHeroMsg');
  const btnSave = document.getElementById('btnSaveArticle');
  const btnBack = document.getElementById('btnBack');

  // Capture existing heroURL if any was set by loader
  if (metaHeroMsg && metaHeroMsg.dataset && metaHeroMsg.dataset.url){
    heroURL = metaHeroMsg.dataset.url;
  }

  // Helper: join pages into HTML
  function composeHTML(){
    return [...document.querySelectorAll('.page')].map(p=> p.innerHTML).join('<!--PAGE_BREAK-->');
  }

  // Auto-save timer
  let t = null;
  function scheduleSave(){
    if(t) clearTimeout(t);
    t = setTimeout(runSave, 2500);
  }

  function markDirty(){
    dirty = true;
    scheduleSave();
  }

  // Listen to edits
  pages.addEventListener('input', markDirty, true);
  metaTitle.addEventListener('input', scheduleSave);
  metaDesc.addEventListener('input', scheduleSave);
  metaEdition.addEventListener('change', scheduleSave);

  // Upload hero to storage if needed
  metaHero.addEventListener('change', async (e)=>{
    const f = e.target.files && e.target.files[0]; if(!f) return;
    try{
      const st = window.storage || getStorage();
      const rf = ref(st, 'articleImages/'+Date.now()+'_'+f.name.replace(/\s+/g,'_'));
      await uploadBytes(rf, f);
      heroURL = await getDownloadURL(rf);
      if(metaHeroMsg){ metaHeroMsg.textContent='Naloženo ✔️'; metaHeroMsg.dataset.url = heroURL; }
      scheduleSave();
    }catch(err){
      if(metaHeroMsg) metaHeroMsg.textContent = 'Napaka: ' + (err && err.message || '');
    }
  });

  async function runSave(manual=false){
    if(!window.db) return;
    const titleV = (metaTitle.value||'').trim() || 'Brez naslova';
    const descV  = (metaDesc.value||'').trim();
    const editionSel = metaEdition.value || editionIdParam || '';

    // Determine content
    const content = composeHTML();

    try{
      // Edition (newspaper) save
      if(editionIdParam){
        await updateDoc(doc(window.db,'editions', editionIdParam), {
          newspaperTitle: titleV,
          newspaperDesc: descV,
          newspaperHtml: content,
          newspaperUpdated: serverTimestamp()
        });
        if (manual) alert('Časopis shranjen ✔️');
        dirty = false;
        return;
      }

      // Article/submission save
      if(articleId){
        const targetCol = (src==='submissions') ? 'submissions' : 'articles';
        await setDoc(doc(window.db, targetCol, articleId), {
          title: titleV,
          desc:  descV,
          editionId: editionSel,
          img: heroURL || '',
          content,
          updated: serverTimestamp(),
          author: window.auth?.currentUser?.uid || 'anon'
        }, { merge: true });
        if (manual) alert('Shranjeno ✔️');
        dirty = false;
        return;
      }

      // New doc without id → save lightweight draft to localStorage
      const draft = { title: titleV, desc: descV, editionId: editionSel, img: heroURL||'', content };
      localStorage.setItem('draft_new_article', JSON.stringify(draft));
      if (manual) alert('Osnutek shranjen lokalno ✔️');
      dirty = false;
    }catch(e){
      if (manual) alert('Napaka pri shranjevanju: ' + (e && e.message || e));
    }
  }

  // Manual Save button
  btnSave.addEventListener('click', async ()=>{
    await runSave(true);
    history.back();
  });

  // Before unload warn if dirty
  window.addEventListener('beforeunload', (e)=>{
    if(dirty){
      e.preventDefault();
      e.returnValue = '';
      return '';
    }
  });

  // Back without save (warn)
  btnBack.addEventListener('click', ()=>{
    if(dirty && !confirm('Spremembe niso shranjene. Želiš vseeno nazaj?')) return;
    history.back();
  });

  // If we have local draft and creating new → restore into UI
  (function restoreDraftIfAny(){
    if(articleId || editionIdParam) return;
    try{
      const x = localStorage.getItem('draft_new_article');
      if(!x) return;
      const d = JSON.parse(x);
      if(d.title) metaTitle.value = d.title;
      if(d.desc) metaDesc.value = d.desc;
      if(d.editionId) metaEdition.value = d.editionId;
      heroURL = d.img || '';
      if(d.content){
        const parts = String(d.content).split('<!--PAGE_BREAK-->');
        const pagesEl = document.getElementById('pages'); pagesEl.innerHTML='';
        parts.forEach(h=>{
          const div=document.createElement('div'); div.className='page'; div.contentEditable='true'; div.innerHTML=h||'<p>&nbsp;</p>';
          pagesEl.appendChild(div);
        });
      }
    }catch{}
  })();

})();
</script>


<script>
(function(){
  function addRibbonImageTools(){
    const insertPanel = document.querySelector('.panel[data-panel="insert"] .group');
    if(!insertPanel) return;
    const mk = (id, label)=>{ const b=document.createElement('button'); b.className='btn'; b.id=id; b.textContent=label; return b; };
    const bFloat = mk('imgFloat','Plavajoča slika');
    const bInline= mk('imgInline','V vrstici');
    const bFront = mk('imgFront','Na vrh');
    const bBack  = mk('imgBack','Na dno');
    const bNext  = mk('imgToNext','Na naslednjo stran');
    const bPrev  = mk('imgToPrev','Na prejšnjo stran');
    insertPanel.appendChild(bFloat);
    insertPanel.appendChild(bInline);
    insertPanel.appendChild(bFront);
    insertPanel.appendChild(bBack);
    insertPanel.appendChild(bNext);
    insertPanel.appendChild(bPrev);

    function getCurrentImage(){
      const sel = document.getSelection();
      if(!sel || !sel.anchorNode) return null;
      let node = sel.anchorNode.nodeType===1 ? sel.anchorNode : sel.anchorNode.parentElement;
      if(!node) return null;
      const inFloat = node.closest('.img-float');
      if(inFloat) return inFloat;
      if(node.tagName==='IMG') return node;
      const img = node.querySelector && node.querySelector('img.selected, img'); 
      return img || inFloat || null;
    }
    function ensureFloat(img){
      if(!img) return null;
      if(img.classList && img.classList.contains('img-float')) return img;
      if(img.closest && img.closest('.img-float')) return img.closest('.img-float');
      if(img.tagName === 'IMG'){
        const page = img.closest('.page') || document.querySelector('.page');
        const box = document.createElement('div');
        const rect = img.getBoundingClientRect();
        const prect= page.getBoundingClientRect();
        box.className='img-float selected';
        box.style.left = Math.max(0, rect.left - prect.left + page.scrollLeft) + 'px';
        box.style.top  = Math.max(0, rect.top - prect.top  + page.scrollTop ) + 'px';
        box.style.width = rect.width + 'px';
        box.style.height= rect.height + 'px';
        img.parentNode.insertBefore(box, img);
        box.appendChild(img);
        img.style.width='100%'; img.style.height='100%';
        ['nw','ne','sw','se'].forEach(k=>{ const h=document.createElement('div'); h.className='resize '+k; box.appendChild(h); });
        enableFloatHandlers(box);
        return box;
      }
      return null;
    }
    function toInline(box){
      if(!box) return;
      const img = box.querySelector('img');
      const p = box.closest('.page');
      const caret = document.getSelection();
      box.remove();
      if(caret && caret.rangeCount){
        caret.getRangeAt(0).insertNode(img);
      }else{
        p.appendChild(img);
      }
      img.removeAttribute('style');
    }
    function zAdjust(box, dir){
      if(!box) return;
      const z = parseInt(box.style.zIndex || '1',10);
      box.style.zIndex = String(Math.max(1, z + dir));
    }
    function moveToPage(box, step){
      if(!box) return;
      const page = box.closest('.page');
      const all = Array.from(document.querySelectorAll('.page'));
      const idx = all.indexOf(page);
      const next = all[idx + step];
      if(next){
        next.appendChild(box);
        box.style.left = '10px';
        box.style.top = '10px';
      }
    }

    document.getElementById('imgFloat').onclick = ()=> ensureFloat(getCurrentImage());
    document.getElementById('imgInline').onclick= ()=> { const el=getCurrentImage(); const box = ensureFloat(el); toInline(box); };
    document.getElementById('imgFront').onclick = ()=> { const box = ensureFloat(getCurrentImage()); zAdjust(box, +1); };
    document.getElementById('imgBack').onclick  = ()=> { const box = ensureFloat(getCurrentImage()); zAdjust(box, -1); };
    document.getElementById('imgToNext').onclick= ()=> moveToPage(ensureFloat(getCurrentImage()), +1);
    document.getElementById('imgToPrev').onclick= ()=> moveToPage(ensureFloat(getCurrentImage()), -1);
  }

  function enableFloatHandlers(box){
    const page = box.closest('.page');
    let startX=0, startY=0, startL=0, startT=0, startW=0, startH=0, resizing=null, dragging=false;

    function withinPage(x,y){
      const pr = page.getBoundingClientRect();
      x = Math.max(0, Math.min(x, pr.width - box.offsetWidth));
      y = Math.max(0, Math.min(y, pr.height - box.offsetHeight));
      return {x,y};
    }

    box.addEventListener('mousedown', (e)=>{
      if(e.target.classList.contains('resize')){
        resizing = e.target.classList.contains('se') ? 'se' :
                   e.target.classList.contains('sw') ? 'sw' :
                   e.target.classList.contains('ne') ? 'ne' : 'nw';
      }else{
        dragging = true;
      }
      box.classList.add('selected');
      const br = box.getBoundingClientRect();
      startX = e.clientX; startY = e.clientY;
      startL = br.left; startT = br.top; startW = br.width; startH = br.height;
      e.preventDefault();
    });
    document.addEventListener('mousemove', (e)=>{
      if(!dragging && !resizing) return;
      const pr = page.getBoundingClientRect();
      if(dragging){
        const nx = startL + (e.clientX - startX) - pr.left + page.scrollLeft;
        const ny = startT + (e.clientY - startY) - pr.top  + page.scrollTop;
        const pos = withinPage(nx, ny);
        box.style.left = pos.x + 'px';
        box.style.top  = pos.y + 'px';
      }else if(resizing){
        let w = startW, h = startH;
        if(resizing==='se'){ w += (e.clientX - startX); h += (e.clientY - startY); }
        if(resizing==='sw'){ w -= (e.clientX - startX); h += (e.clientY - startY); box.style.left = (parseFloat(box.style.left||'0') + (e.clientX - startX)) + 'px'; }
        if(resizing==='ne'){ w += (e.clientX - startX); h -= (e.clientY - startY); box.style.top  = (parseFloat(box.style.top||'0')  + (e.clientY - startY)) + 'px'; }
        if(resizing==='nw'){ w -= (e.clientX - startX); h -= (e.clientY - startY); box.style.left = (parseFloat(box.style.left||'0') + (e.clientX - startX)) + 'px'; box.style.top  = (parseFloat(box.style.top||'0')  + (e.clientY - startY)) + 'px'; }
        w = Math.max(40, w); h = Math.max(40, h);
        // keep aspect ratio of inner img
        const img = box.querySelector('img');
        if(img && img.naturalWidth && img.naturalHeight){
          const ar = img.naturalWidth / img.naturalHeight;
          if(w/h > ar) w = h * ar; else h = w / ar;
        }
        // clamp inside page
        const maxW = page.clientWidth - parseFloat(box.style.left||'0');
        const maxH = page.clientHeight - parseFloat(box.style.top ||'0');
        box.style.width  = Math.min(maxW, w) + 'px';
        box.style.height = Math.min(maxH, h) + 'px';
      }
    });
    document.addEventListener('mouseup', ()=>{ dragging=false; resizing=null; });
  }

  // Enable handlers for any pre-existing .img-float (if loaded)
  document.addEventListener('DOMContentLoaded', ()=>{
    document.querySelectorAll('.img-float').forEach(enableFloatHandlers);
    addRibbonImageTools();
  });

  // When inserting image via 'insertImage', wrap as float by default
  const imgInput = document.getElementById('imageFile');
  if(imgInput){
    imgInput.addEventListener('change', function hookWrap(e){
      const pages = document.getElementById('pages');
      setTimeout(()=>{
        // wrap last inserted <img> if any without wrapper
        const imgs = pages.querySelectorAll('img');
        if(!imgs.length) return;
        const img = imgs[imgs.length-1];
        if(img.closest('.img-float')) return;
        const page = img.closest('.page') || pages.querySelector('.page');
        const box = document.createElement('div');
        box.className='img-float selected';
        box.style.left='10px'; box.style.top='10px';
        box.style.width = (Math.min(300, page.clientWidth-20)) + 'px';
        const ar = (img.naturalWidth && img.naturalHeight) ? (img.naturalWidth / img.naturalHeight) : 1.5;
        box.style.height= Math.round(parseFloat(box.style.width)/ar) + 'px';
        img.parentNode.insertBefore(box, img);
        box.appendChild(img);
        img.style.width='100%'; img.style.height='100%';
        ['nw','ne','sw','se'].forEach(k=>{ const h=document.createElement('div'); h.className='resize '+k; box.appendChild(h); });
        enableFloatHandlers(box);
      }, 30);
    });
  }
})();
</script>


<script>
(function(){
  const pages = document.getElementById('pages');

  function newPage(html){
    const d = document.createElement('div');
    d.className='page'; d.contentEditable='true'; d.innerHTML = html || '<p>&nbsp;</p>';
    pages.appendChild(d);
    return d;
  }
  function isEmptyPage(p){
    const txt = p.innerText.replace(/\u200B/g,'').trim();
    const imgs = p.querySelectorAll('img, .img-float').length;
    // consider empty if only whitespace or a single &nbsp;
    return !imgs && (!txt || txt === '');
  }

  function splitOverflow(p){
    const maxH = p.clientHeight;
    if(p.scrollHeight <= maxH) return;
    let np = p.nextElementSibling;
    if(!np || !np.classList.contains('page')) np = newPage();
    // Move nodes from bottom until fits
    const moved = [];
    let i = p.childNodes.length - 1;
    while(i >= 0 && p.scrollHeight > maxH){
      const n = p.childNodes[i];
      moved.unshift(n);
      i--;
      if(n) p.removeChild(n);
    }
    // If nothing could be moved (e.g., single huge node), move it anyway
    if(!moved.length && p.childNodes.length){
      const n = p.childNodes[p.childNodes.length-1];
      moved.unshift(n);
      p.removeChild(n);
    }
    moved.forEach(n=> np.insertBefore(n, np.firstChild));
    // Recursively handle next page too
    splitOverflow(np);
  }

  function collapseEmptyTail(){
    let all = pages.querySelectorAll('.page');
    while(all.length > 1){
      const last = all[all.length-1];
      if(isEmptyPage(last)){
        last.remove();
        all = pages.querySelectorAll('.page');
      }else break;
    }
  }

  function enforcePagination(){
    pages.querySelectorAll('.page').forEach(p=>{
      if(p.scrollHeight > p.clientHeight + 2){
        p.classList.add('overflowing');
        splitOverflow(p);
        p.classList.remove('overflowing');
      }
    });
    collapseEmptyTail();
  }

  // Run on input/change
  pages.addEventListener('input', enforcePagination);
  pages.addEventListener('keyup', (e)=>{
    // If user pressed backspace on last empty page, remove it
    if(e.key === 'Backspace' || e.key === 'Delete'){
      collapseEmptyTail();
    }
  });

  // Also observe mutations (e.g., image drag/resize)
  const mo = new MutationObserver(()=> enforcePagination());
  mo.observe(pages, { childList:true, subtree:true, attributes:true, characterData:true });

  // Initial check after load
  window.addEventListener('load', enforcePagination);
})();
</script>


<!-- ==== Admin-only save & no-local-storage policy (inserted by ChatGPT) ==== -->
<script>
(function(){
  // Hide local "Save as HTML" to prevent local saving
  const btnSaveHtml = document.getElementById('btnSaveHtml');
  if (btnSaveHtml) {
    btnSaveHtml.style.display = 'none';
    btnSaveHtml.onclick = (e)=>{ e.preventDefault(); alert('Lokalno shranjevanje je onemogočeno.'); };
  }

  // Disable localStorage drafts
  const blockKeys = new Set(['editor_draft','draft_new_article']);
  try {
    const _setItem = window.localStorage && window.localStorage.setItem;
    if (_setItem) {
      window.localStorage.setItem = function(k, v){
        if (blockKeys.has(String(k))) return;
        return _setItem.apply(this, arguments);
      };
    }
    // Wipe existing drafts
    blockKeys.forEach(k=> localStorage.removeItem(k));
  } catch(e){}

  // Helper: detect Firebase
  function hasFB(){ return !!(window.db && window.auth); }
  function mustFB(){
    if (!hasFB()) { alert('Ni povezave s strežnikom. Prijavi se (Firebase) – lokalno shranjevanje je onemogočeno.'); return false; }
    return true;
  }

  // Ensure first page is not empty if later pages have content
  function removeLeadingEmptyPages(){
    const pages = document.getElementById('pages');
    if(!pages) return;
    const list = Array.from(pages.querySelectorAll('.page'));
    for (let i=0; i<list.length-1; i++){
      const p = list[i];
      const hasImgs = p.querySelector('img, .img-float');
      const txt = (p.innerText||'').replace(/\u200B/g,'').trim();
      if (!hasImgs && !txt) {
        p.remove();
      } else {
        break;
      }
    }
  }

  // Hook DOCX import to avoid empty first page and reflow
  (function hookDocx(){
    const input = document.getElementById('docxInput');
    if (!input) return;
    input.addEventListener('change', ()=> setTimeout(()=>{
      try { window.__reflow && window.__reflow(); } catch(e){}
      removeLeadingEmptyPages();
    }, 0));
  })();

  // Hook image insertion to reflow & avoid empty top page
  (function hookImage(){
    const imgInput = document.getElementById('imageFile');
    if (!imgInput) return;
    imgInput.addEventListener('change', ()=> setTimeout(()=>{
      try { window.__reflow && window.__reflow(); } catch(e){}
      removeLeadingEmptyPages();
    }, 30));
  })();

  // Force admin save only (no local download fallbacks)
  (function overrideSaveButtons(){
    const btn = document.getElementById('btnSaveArticle');
    if (btn) {
      btn.onclick = async function(e){
        e.preventDefault();
        if(!mustFB()) return;
        const { doc, setDoc, addDoc, updateDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
        // Gather data
        const title = (document.getElementById('metaTitle').value||'').trim() || 'Brez naslova';
        const desc  = (document.getElementById('metaDesc').value||'').trim();
        const editionId = (document.getElementById('metaEdition').value||'').trim();
        const hero = (document.getElementById('metaHeroMsg')?.dataset?.url) || '';
        const pages = document.getElementById('pages');
        const content = [...pages.querySelectorAll('.page')].map(p=> p.innerHTML).join('<!--PAGE_BREAK-->');

        // If there is an ?id, update that article; else submit into 'submissions' for admin
        const params = new URLSearchParams(location.search);
        const articleId = params.get('id');
        try {
          if (articleId) {
            await setDoc(doc(window.db, 'articles', articleId), { 
              title, desc, editionId, img: hero, content, updated: serverTimestamp(), 
              author: window.auth.currentUser?.uid || 'anon', approved: false 
            }, { merge: true });
          } else {
            await addDoc(collection(window.db, 'submissions'), { 
              title, desc, editionId, img: hero, content, created: serverTimestamp(),
              author: window.auth.currentUser?.uid || 'anon', processed: false
            });
          }
          alert('Poslano adminu ✔️');
          history.back();
        } catch (err){
          alert('Napaka pri pošiljanju adminu: ' + (err && err.message || err));
        }
      };
    }

    // On print keep allowed
    // On New Page keep allowed
  })();

  // Prevent any legacy download fallbacks by intercepting Blob URLs used for save
  (function blockDownloads(){
    const _createObjectURL = URL.createObjectURL;
    URL.createObjectURL = function(obj){
      try{
        if (obj && obj.type && /text\/html/i.test(obj.type)) {
          throw new Error('Lokalno shranjevanje HTML je onemogočeno.');
        }
      }catch(e){ alert('Lokalno shranjevanje je onemogočeno.'); throw e; }
      return _createObjectURL.apply(this, arguments);
    };
  })();

  // Run after load as safety
  document.addEventListener('DOMContentLoaded', removeLeadingEmptyPages);
  window.addEventListener('load', removeLeadingEmptyPages);
})();
</script>

<!-- ==== Force SUBMISSIONS save (no local), unprocessed for admin; prefer editing in submissions ==== -->
<script>
(function(){
  // --- UI: hide "Save as HTML" completely and block fallback downloads
  const btnSaveHtml = document.getElementById('btnSaveHtml');
  if (btnSaveHtml){ btnSaveHtml.style.display='none'; btnSaveHtml.onclick = (e)=>{ e.preventDefault(); alert('Lokalno shranjevanje je onemogočeno.'); }; }
  const origCreateURL = URL.createObjectURL;
  URL.createObjectURL = function(obj){
    try{
      if (obj && obj.type && /text\/html/i.test(obj.type)) throw new Error('Local save disabled');
    }catch(e){ alert('Lokalno shranjevanje je onemogočeno.'); throw e; }
    return origCreateURL.apply(this, arguments);
  };

  // --- Disable local drafts entirely
  try{
    const blockKeys = new Set(['editor_draft','draft_new_article']);
    const _set = localStorage.setItem.bind(localStorage);
    localStorage.setItem = (k,v)=>{ if(blockKeys.has(String(k))) return; return _set(k,v); };
    blockKeys.forEach(k=> localStorage.removeItem(k));
  }catch(e){}

  // --- Helper: compose HTML from pages
  function pagesHTML(){
    const wrap = document.getElementById('pages');
    if(!wrap) return '';
    return [...wrap.querySelectorAll('.page')].map(p=> p.innerHTML).join('<!--PAGE_BREAK-->');
  }

  // --- Helper: remove leading empty pages & reflow if available
  function removeLeadingEmptyPages(){
    const pages = document.getElementById('pages');
    if(!pages) return;
    const list = Array.from(pages.querySelectorAll('.page'));
    for (let i=0; i<list.length-1; i++){
      const pg = list[i];
      const hasImgs = pg.querySelector('img, .img-float');
      const txt = (pg.innerText||'').replace(/\u200B/g,'').trim();
      if(!hasImgs && !txt) pg.remove(); else break;
    }
    try{ window.__reflow && window.__reflow(); }catch{}
  }
  document.addEventListener('DOMContentLoaded', removeLeadingEmptyPages);
  window.addEventListener('load', removeLeadingEmptyPages);

  // --- After DOCX or image: tidy top blank page
  (function hookDocxImg(){
    const di = document.getElementById('docxInput');
    const ii = document.getElementById('imageFile');
    if(di) di.addEventListener('change', ()=> setTimeout(removeLeadingEmptyPages, 30));
    if(ii) ii.addEventListener('change', ()=> setTimeout(removeLeadingEmptyPages, 30));
  })();

  // --- Force SAVE: always to 'submissions', processed:false; allow continued editing there
  async function saveToSubmissions(){
    if(!(window.db && window.auth)){
      alert('Ni povezave s strežnikom (Firebase). Prijavi se.'); 
      return;
    }
    const { doc, setDoc, addDoc, collection, serverTimestamp, getDoc } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");

    const title = (document.getElementById('metaTitle').value||'').trim() || 'Brez naslova';
    const desc  = (document.getElementById('metaDesc').value||'').trim();
    const editionId = (document.getElementById('metaEdition').value||'').trim();
    const hero = (document.getElementById('metaHeroMsg')?.dataset?.url)||'';
    const content = pagesHTML();

    const params = new URLSearchParams(location.search);
    const id = params.get('id') || '';
    const src = (params.get('src')||'').toLowerCase();

    try{
      let targetId = id;
      // If we have an id but it's not in submissions, create new submission
      if(targetId && src==='submissions'){
        await setDoc(doc(window.db,'submissions', targetId), {
          title, desc, editionId, img: hero, content,
          processed:false, // unprocessed for admin
          updated: serverTimestamp(),
          author: window.auth.currentUser?.uid || 'anon'
        }, { merge:true });
      }else if(targetId && src!=='submissions'){
        // we came from articles or unspecified → create a new submission
        const r = await addDoc(collection(window.db,'submissions'), {
          title, desc, editionId, img: hero, content,
          processed:false,
          created: serverTimestamp(),
          author: window.auth.currentUser?.uid || 'anon',
          sourceArticleId: targetId
        });
        targetId = r.id;
        // update URL to reflect editing in submissions going forward
        const newUrl = new URL(location.href);
        newUrl.searchParams.set('id', targetId);
        newUrl.searchParams.set('src', 'submissions');
        history.replaceState({}, '', newUrl.toString());
      }else{
        // no id → new submission
        const r = await addDoc(collection(window.db,'submissions'), {
          title, desc, editionId, img: hero, content,
          processed:false,
          created: serverTimestamp(),
          author: window.auth.currentUser?.uid || 'anon'
        });
        targetId = r.id;
        const newUrl = new URL(location.href);
        newUrl.searchParams.set('id', targetId);
        newUrl.searchParams.set('src', 'submissions');
        history.replaceState({}, '', newUrl.toString());
      }
      alert('Poslano adminu kot NEOBDELANO ✔️\nUrejanje se nadaljuje v osnutku v “submissions”.');
    }catch(err){
      alert('Napaka pri shranjevanju v submissions: ' + (err && err.message || err));
    }
  }

  // Bind the Save button
  const btn = document.getElementById('btnSaveArticle');
  if(btn){
    btn.onclick = (e)=>{ e.preventDefault(); saveToSubmissions(); };
    btn.textContent = '💾 Pošlji adminu';
  }

  // --- Prefer loading from submissions (if ?id exists without src)
  document.addEventListener('DOMContentLoaded', async ()=>{
    const params = new URLSearchParams(location.search);
    const id = params.get('id'); const src = (params.get('src')||'').toLowerCase();
    if(!id || src) return; // already resolved
    if(!(window.db)) return;
    try{
      const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
      const sSnap = await getDoc(doc(window.db, 'submissions', id));
      if(sSnap.exists()){
        // Switch URL to submissions context so all future saves stay in submissions
        const u = new URL(location.href);
        u.searchParams.set('src','submissions');
        history.replaceState({},'',u.toString());
      }
    }catch(e){}
  });

})();
</script>
</body>
</html>
